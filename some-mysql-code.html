<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>一些MySQL代码片段 | Winter`s Notes</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="canonical" href="https://summerandwinter.github.io/some-mysql-code.html"><meta name="description" content="记录一些实用的MySQL代码片段"><meta name="keywords" content="MySQL,代码片段,字段合并"><meta property="og:type" content="article"><meta property="og:title" content="一些MySQL代码片段"><meta property="og:url" content="https://summerandwinter.github.io/some-mysql-code.html"><meta property="og:site_name" content="Winter`s Notes"><meta property="og:description" content="记录一些实用的MySQL代码片段"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2019-11-28T08:58:49.415Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="一些MySQL代码片段"><meta name="twitter:description" content="记录一些实用的MySQL代码片段"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/css/gitment.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/css/article.css"></head></html><body><div id="container"><div id="wrap"><header id="header" class="header"><nav id="main-nav" class="main-nav"> <a class="main-nav-link" href="/">主页</a> <a class="main-nav-link" href="/archives">归档</a> <a class="main-nav-link" href="/category">分类</a> <a class="main-nav-link" href="/tag">标签</a></nav><nav id="sub-nav"></nav></header><div class="outer"><section id="main"><div class="article-container"><article id="post-some-mysql-code" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name"> 一些MySQL代码片段</h1></header><div class="article-entry typo" itemprop="articleBody"><h1 id="获取表结构"><a href="#获取表结构" class="headerlink" title="获取表结构"></a>获取表结构</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT   </span><br><span class="line">cols.TABLE_SCHEMA,                    //数据库名  </span><br><span class="line">cols.TABLE_NAME,                        //表名  </span><br><span class="line">cols.COLUMN_NAME,                    //列名  </span><br><span class="line">cols.ORDINAL_POSITION,             //列明排序  </span><br><span class="line">cols.COLUMN_DEFAULT,               //默认值  </span><br><span class="line">cols.IS_NULLABLE,                       //是否允许控制   </span><br><span class="line">cols.DATA_TYPE,                           //数据类型  </span><br><span class="line">cols.CHARACTER_MAXIMUM_LENGTH,     //最大长度（字符为单位）  </span><br><span class="line">cols.CHARACTER_OCTET_LENGTH,       //最大长度（字节为单位）  </span><br><span class="line">cols.NUMERIC_PRECISION,            //精度  </span><br><span class="line">cols.NUMERIC_SCALE,                //小数位数  </span><br><span class="line">cols.COLUMN_KEY,                   //主键  </span><br><span class="line">cols.COLUMN_COMMENT                //备注  </span><br><span class="line">FROM                                 </span><br><span class="line">information_schema.`COLUMNS` AS cols   </span><br><span class="line">WHERE cols.TABLE_SCHEMA = ’databasename’   </span><br><span class="line">AND cols.TABLE_NAME = ’tablename’;</span><br></pre></td></tr></table></figure><p>其他字段</p><table><thead><tr><th style="text-align:left">列名</th><th style="text-align:left">数据类型</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">TABLE_CATALOG</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">表限定符。</td></tr><tr><td style="text-align:left">TABLE_SCHEMA</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">表所有者。</td></tr><tr><td style="text-align:left">TABLE_NAME</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">表名。</td></tr><tr><td style="text-align:left">COLUMN_NAME</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">列名。</td></tr><tr><td style="text-align:left">ORDINAL_POSITION</td><td style="text-align:left">smallint</td><td style="text-align:left">列标识号。</td></tr><tr><td style="text-align:left">COLUMN_DEFAULT</td><td style="text-align:left">nvarchar(4000)</td><td style="text-align:left">列的默认值。</td></tr><tr><td style="text-align:left">IS_NULLABLE</td><td style="text-align:left">varchar(3)</td><td style="text-align:left">列的为空性。如果列允许 NULL，那么该列返回 YES。否则，返回 NO。</td></tr><tr><td style="text-align:left">DATA_TYPE</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">系统提供的数据类型。</td></tr><tr><td style="text-align:left">CHARACTER_MAXIMUM_LENGTH</td><td style="text-align:left">smallint</td><td style="text-align:left">以字符为单位的最大长度，适于二进制数据、字符数据，或者文本和图像数据。否则，返回 NULL。</td></tr><tr><td style="text-align:left">CHARACTER_OCTET_LENGTH</td><td style="text-align:left">smallint</td><td style="text-align:left">以字节为单位的最大长度，适于二进制数据、字符数据，或者文本和图像数据。否则，返回 NULL。</td></tr><tr><td style="text-align:left">NUMERIC_PRECISION</td><td style="text-align:left">tinyint</td><td style="text-align:left">近似数字数据、精确数字数据、整型数据或货币数据的精度。否则，返回 NULL。</td></tr><tr><td style="text-align:left">NUMERIC_PRECISION_RADIX</td><td style="text-align:left">smallint</td><td style="text-align:left">近似数字数据、精确数字数据、整型数据或货币数据的精度基数。否则，返回 NULL。</td></tr><tr><td style="text-align:left">NUMERIC_SCALE</td><td style="text-align:left">tinyint</td><td style="text-align:left">近似数字数据、精确数字数据、整数数据或货币数据的小数位数。否则，返回 NULL。</td></tr><tr><td style="text-align:left">DATETIME_PRECISION</td><td style="text-align:left">smallint</td><td style="text-align:left">datetime 及 SQL-92 interval 数据类型的子类型代码。对于其它数据类型，返回 NULL。</td></tr><tr><td style="text-align:left">CHARACTER_SET_CATALOG</td><td style="text-align:left">varchar(6)</td><td style="text-align:left">如果列是字符数据或 text 数据类型，那么返回 master，指明字符集所在的数据库。否则，返回 NULL。</td></tr><tr><td style="text-align:left">CHARACTER_SET_SCHEMA</td><td style="text-align:left">varchar(3)</td><td style="text-align:left">如果列是字符数据或 text 数据类型，那么返回 DBO，指明字符集的所有者名称。否则，返回 NULL。</td></tr><tr><td style="text-align:left">CHARACTER_SET_NAME</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">如果该列是字符数据或 text 数据类型，那么为字符集返回唯一的名称。否则，返回 NULL。</td></tr><tr><td style="text-align:left">COLLATION_CATALOG</td><td style="text-align:left">varchar(6)</td><td style="text-align:left">如果列是字符数据或 text 数据类型，那么返回 master，指明在其中定义排序次序的数据库。否则此列为 NULL。</td></tr><tr><td style="text-align:left">COLLATION_SCHEMA</td><td style="text-align:left">varchar(3)</td><td style="text-align:left">返回 DBO，为字符数据或 text 数据类型指明排序次序的所有者。否则，返回 NULL。</td></tr><tr><td style="text-align:left">COLLATION_NAME</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">如果列是字符数据或 text 数据类型，那么为排序次序返回唯一的名称。否则，返回 NULL。</td></tr><tr><td style="text-align:left">DOMAIN_CATALOG</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">如果列是一种用户定义数据类型，那么该列是某个数据库名称，在该数据库名中创建了这种用户定义数据类型。否则，返回 NULL。</td></tr><tr><td style="text-align:left">DOMAIN_SCHEMA</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">如果列是一种用户定义数据类型，那么该列是这种用户定义数据类型的创建者。否则，返回 NULL。</td></tr><tr><td style="text-align:left">DOMAIN_NAME</td><td style="text-align:left">nvarchar(128)</td><td style="text-align:left">如果列是一种用户定义数据类型，那么该列是这种用户定义数据类型的名称。否则，返回 NULL。</td></tr></tbody></table><h1 id="合并字段"><a href="#合并字段" class="headerlink" title="合并字段"></a>合并字段</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT GROUP_CONCAT(col_name order by order_col_name asc SEPARATOR ”) AS   </span><br><span class="line">screen_name FROM table_name  </span><br><span class="line">WHERE …</span><br></pre></td></tr></table></figure><h1 id="合并字段后插入同一张表"><a href="#合并字段后插入同一张表" class="headerlink" title="合并字段后插入同一张表"></a>合并字段后插入同一张表</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO tablename(  </span><br><span class="line">clos,…,something  </span><br><span class="line">      ) VALUES (  </span><br><span class="line">vals,…,  </span><br><span class="line">      (SELECT temp.screen_name FROM (  </span><br><span class="line">      SELECT CONCAT(GROUP_CONCAT(col_name order by order_col_name asc SEPARATOR ”),’add_str’ )  </span><br><span class="line">      AS screen_name   </span><br><span class="line">      FROM tablename  </span><br><span class="line">      WHERE…  </span><br><span class="line">)temp  </span><br><span class="line">      )  </span><br><span class="line">      )   </span><br><span class="line">```      </span><br><span class="line"># 随机查询</span><br><span class="line">**1.最简单的方法 在ORDER BY条件中使用 RAND()方法(资源消耗大，速度慢)**</span><br><span class="line">```mysql</span><br><span class="line">SELECT * FROM table ORDER BY RAND() LIMIT 1</span><br></pre></td></tr></table></figure><p><strong>2.询max(id) * rand()来随机获取数据</strong><br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT *  </span><br><span class="line">FROM `table`  </span><br><span class="line">WHERE id &gt;= (SELECT FLOOR( MAX(id) * RAND()) FROM `table` )  </span><br><span class="line">ORDER BY id LIMIT 1;</span><br></pre></td></tr></table></figure><p></p><p><strong>3.或者使用JOIN方法（比用WHERE效率高）</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT *  </span><br><span class="line">FROM `table` AS t1 JOIN (SELECT ROUND(RAND() * (SELECT MAX(id) FROM `table`)) AS id) AS t2  </span><br><span class="line">WHERE t1.id &gt;= t2.id  </span><br><span class="line">ORDER BY t1.id ASC LIMIT 1;</span><br></pre></td></tr></table></figure><p><strong>4.优化后</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM `table`  </span><br><span class="line">WHERE id &gt;= (SELECT floor(RAND() * (SELECT MAX(id) FROM `table`)))  </span><br><span class="line">ORDER BY id LIMIT 1; </span><br><span class="line">``` </span><br><span class="line">**5.加上MIN(id)的判断**</span><br><span class="line"></span><br><span class="line">```mysql</span><br><span class="line">SELECT * FROM `table`  </span><br><span class="line">WHERE id &gt;= (SELECT floor( RAND() * ((SELECT MAX(id) FROM `table`)-(SELECT MIN(id) FROM `table`)) + (SELECT MIN(id) FROM `table`)))  </span><br><span class="line">ORDER BY id LIMIT 1;  </span><br><span class="line">  </span><br><span class="line">SELECT *  </span><br><span class="line">FROM `table` AS t1 JOIN (SELECT ROUND(RAND() * ((SELECT MAX(id) FROM `table`)-(SELECT MIN(id) FROM `table`))+(SELECT MIN(id) FROM `table`)) AS id) AS t2  </span><br><span class="line">WHERE t1.id &gt;= t2.id  </span><br><span class="line">ORDER BY t1.id LIMIT 1;</span><br></pre></td></tr></table></figure><div class="end-of-file">END</div></div><footer class="article-footer"><ul class="article-meta"><li> <span class="label">发布:</span> <a href="/some-mysql-code.html" class="article-date"><time datetime="2013-11-14T16:27:49.000Z" itemprop="datePublished">2013-11-14</time></a></li><li> <span class="label">分类:</span><div class="article-category"> <a class="article-category-link" href="/category/MySQL/">MySQL</a></div></li><li> <span class="label">标签:</span><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tag/MySQL/">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tag/代码片段/">代码片段</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tag/字段合并/">字段合并</a></li></ul></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"> <a href="/javascript-event-keycode.html" id="article-nav-newer" class="article-nav-link-wrap newer"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title"> Keycode对照表</div></a> <a href="/ajax-loading-gif-tool.html" id="article-nav-older" class="article-nav-link-wrap older"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">Ajaxload动态加载动画生成工具的实现（ajaxload的本地移植）</div></a></nav></article><aside id="article-toc" role="navigation" class="article-toc"><div id="article-toc-inner"> <strong class="sidebar-title">目录</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#获取表结构"><span class="toc-text">获取表结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#合并字段"><span class="toc-text">合并字段</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#合并字段后插入同一张表"><span class="toc-text">合并字段后插入同一张表</span></a></li></ol> <a href="#" id="article-toc-top">回到顶部</a></div></aside><section id="gitment_ccomments" class="comments"><div id="gitment_container"></div></section></div></section></div><footer id="footer" class="post-footer footer"><div id="footerContent" class="footer-content"><div class="end-of-file">Live Happy Love Hard</div></div></footer></div><script src="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/js/gitment.js"></script><script>var date="Thu Nov 14 2013 16:27:49 GMT+0000",id=""+new Date(date).getTime(),gitment=new Gitment({id:id,owner:"summerandwinter",repo:"summerandwinter.github.io",oauth:{client_id:"7b432b7b46e71966fd88",client_secret:"2c697bec7b012bca975de41c87863d84086f8d81"}});gitment.render("gitment_container")</script><script src="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/js/summer.js"></script><!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]--></div></body>