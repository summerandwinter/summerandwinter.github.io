<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>Apache与Tomcat实现负载均衡和集群 | Winter`s Notes</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="canonical" href="https://summerandwinter.github.io/apachetomcatloadbalancingandclustering.html"><meta name="description" content="参照网上的教程实现了Apache与Tomcat实现负载均衡和集群，中间走了一些弯路，最终还是配置成功了。不过只是配置成功了，中间很多的参数和实现的原理都不是很明白，留到以后继续深挖，这里做个记录备忘。"><meta name="keywords" content="Apache,Tomcat,负载均衡,集群"><meta property="og:type" content="article"><meta property="og:title" content="Apache与Tomcat实现负载均衡和集群"><meta property="og:url" content="https://summerandwinter.github.io/apachetomcatloadbalancingandclustering.html"><meta property="og:site_name" content="Winter`s Notes"><meta property="og:description" content="参照网上的教程实现了Apache与Tomcat实现负载均衡和集群，中间走了一些弯路，最终还是配置成功了。不过只是配置成功了，中间很多的参数和实现的原理都不是很明白，留到以后继续深挖，这里做个记录备忘。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/assets/images/articles/tomcat-config-port.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/assets/images/articles/tomcat-config-xml.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/assets/images/articles/cmd-output.jpg"><meta property="og:updated_time" content="2019-11-28T08:58:49.415Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Apache与Tomcat实现负载均衡和集群"><meta name="twitter:description" content="参照网上的教程实现了Apache与Tomcat实现负载均衡和集群，中间走了一些弯路，最终还是配置成功了。不过只是配置成功了，中间很多的参数和实现的原理都不是很明白，留到以后继续深挖，这里做个记录备忘。"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/assets/images/articles/tomcat-config-port.jpg"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/css/gitment.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/css/article.css"></head></html><body><div id="container"><div id="wrap"><header id="header" class="header"><nav id="main-nav" class="main-nav"> <a class="main-nav-link" href="/">主页</a> <a class="main-nav-link" href="/archives">归档</a> <a class="main-nav-link" href="/category">分类</a> <a class="main-nav-link" href="/tag">标签</a></nav><nav id="sub-nav"></nav></header><div class="outer"><section id="main"><div class="article-container"><article id="post-apachetomcatloadbalancingandclustering" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name"> Apache与Tomcat实现负载均衡和集群</h1></header><div class="article-entry typo" itemprop="articleBody"><p>参照网上的教程实现了Apache与Tomcat实现负载均衡和集群，中间走了一些弯路，最终还是配置成功了。不过只是配置成功了，中间很多的参数和实现的原理都不是很明白，留到以后继续深挖，这里做个记录备忘。<br><a id="more"></a></p><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>我用了两台机器，机器A和机器B</p><p>Win7 32位 Java 版本 “1.8.0_20”</p><p>机器A的IP为：192.168.1.72 部署 apache和两个tomat(tomcat1,tomcat2)</p><p>机器B的IP为：192.168.1.105 部署一个tomcat（tomcat3）</p><p><strong>软件版本和下载地址</strong></p><p><a href="http://www.apachehaus.com/downloads/httpd-2.2.31-x86-r2.zip" target="_blank" rel="noopener">httpd-2.2.31-x86-r2</a></p><p><a href="http://mirrors.cnnic.cn/apache/tomcat/tomcat-7/v7.0.68/bin/apache-tomcat-7.0.68.zip" target="_blank" rel="noopener">apache-tomcat-7.0.68</a></p><p><a href="http://archive.apache.org/dist/tomcat/tomcat-connectors/jk/binaries/win32/jk-1.2.30/mod_jk-1.2.30-httpd-2.2.3.so" target="_blank" rel="noopener">mod_jk-1.2.30-httpd-2.2.3.so</a></p><p><strong>调试Apache和Tomcat</strong></p><p>首先要在两台机器上成功启动apache和tomcat</p><p><strong>部署Apache</strong></p><p>在机器A上解压httpd-2.2.31-x86-r2.zip，把apache22文件夹拷贝到硬盘根目录，最好是根目录，默认的配置都是配的跟目录，在windows环境下要修改很多配置文件才能启动成功，如果是根目录能直接启动成功。</p><p><strong>部署Tomcat</strong></p><p>在机器A上拷贝两个tomcat分别命名为tomcat1,tomcat2,在机器B拷贝一个tomcat,命名为tomcat3。</p><p>由于在机器A上有两个tomcat，为避免端口冲突tomcat1保持默认配置，修改tomcat2端口。</p><p><img src="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/assets/images/articles/tomcat-config-port.jpg" alt title="修改Tomcat端口。"></p><p>如果Apache和3个Tomcat能成功启动这里步就算完成了。</p><p>为能在页面上直观的感受到负载均衡的效果需要对tomcat中的首页做一点小的改动<br></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">”text/html;</span> <span class="attr">charset</span>=<span class="string">utf-8”</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Cluster Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">tomcat1</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>用上面的代码替换tomcat 下<code>webapps\ROOT</code>目录中的<code>index.jsp</code>文件，并把tomcat1替换当前所在tomcat的名称。</p><h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><p><strong>给apache安装mod_jk链接模块</strong></p><p>把<code>mod_jk-1.2.30-httpd-2.2.3.so</code>重名名为<code>mod_jk.so</code>（重命名不是必须的，也可以不重命名，这里为了名称的简洁，个人习惯）拷贝到apache22下的<code>modules</code>文件夹。</p><p>在config目录下新建两个文件<code>mod_jk.conf</code>和<code>workers.properties</code></p><p>下面是我的配置文件</p><p>mod_jk.conf<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#加载mod_jk Module</span><br><span class="line">LoadModule jk_module modules/mod_jk.so</span><br><span class="line">#指定 workers.properties文件路径</span><br><span class="line">JkWorkersFile conf/workers.properties</span><br><span class="line">#指定那些请求交给tomcat处理,&quot;controller&quot;为在workers.propertise里指定的负载分配控制器</span><br><span class="line">JkMount /* controller</span><br></pre></td></tr></table></figure><p></p><p>workers.properties<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">worker.list = controller,tomcat1,tomcat2,tomcat3 #server 列表</span><br><span class="line">#========tomcat1========</span><br><span class="line">worker.tomcat1.port=8009          #ajp13 端口号，在tomcat下server.xml配置,默认8009</span><br><span class="line">worker.tomcat1.host=192.168.1.72  #tomcat1（机器A）的主机地址，如不为本机，请填写ip地址</span><br><span class="line">worker.tomcat1.type=ajp13</span><br><span class="line">worker.tomcat1.lbfactor = 1       #server的加权比重，值越高，分得的请求越多</span><br><span class="line">#========tomcat2========</span><br><span class="line">worker.tomcat2.port=8109 </span><br><span class="line">worker.tomcat2.host=192.168.1.72   #机器A</span><br><span class="line">worker.tomcat2.type=ajp13</span><br><span class="line">worker.tomcat2.lbfactor = 1 </span><br><span class="line">#========tomcat3========</span><br><span class="line">worker.tomcat3.port=8009 </span><br><span class="line">worker.tomcat3.host=192.168.1.105   #机器B</span><br><span class="line">worker.tomcat3.type=ajp13</span><br><span class="line">worker.tomcat3.lbfactor = 1 </span><br><span class="line">#========controller,负载均衡控制器========</span><br><span class="line">worker.controller.type=lb</span><br><span class="line">worker.controller.balanced_workers=tomcat1,tomcat2,tomcat3   #指定分担请求的tomcat</span><br><span class="line">worker.controller.sticky_session=1</span><br></pre></td></tr></table></figure><p></p><p>在<code>httpd.conf</code>最后加上：<br></p><figure class="highlight plain"><figcaption><span>JK module settings</span></figcaption><table><tr><td class="code"><pre><span class="line">Include conf/mod_jk.conf</span><br></pre></td></tr></table></figure><p></p><p>重启apache服务访问 <a href="http://192.168.1.72" target="_blank" rel="noopener">http://192.168.1.72</a> ,不断刷新页面，如果页面上随机轮换出现tomcat1,tomcat2,tomcat3字样则说明配置成功。</p><p>到这里apache和tomcat的负载均衡就配置好了，apache会按照权重值转发请求到三个tomcat中的一个，但是现在每个tomcat之间还没有实现session复制（也就是集群），每次转发到不同的tomcat时session都会不一样，接下来我们要做的就是配置tomcat的集群。</p><h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><p>修改tomcat1,tomcat2,tomcat3配置文件<code>server.xml</code>中的：<br></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Cluster</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.ha.tcp.SimpleTcpCluster"</span>/&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>这个版本的tomcat中默认为被注释状态，取消注释，并修改为下面这样</p><p><img src="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/assets/images/articles/tomcat-config-xml.jpg" alt title="修改Tomcat配置"></p><p>下面为文字版<br></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Cluster</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.ha.tcp.SimpleTcpCluster”</span> <span class="attr">channelSendOptions</span>=<span class="string">”6”</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.ha.session.BackupManager”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">expireSessionsOnShutdown</span>=<span class="string">”false”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">notifyListenersOnReplication</span>=<span class="string">”true”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">mapSendOptions</span>=<span class="string">”6”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.ha.session.DeltaManager”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">expireSessionsOnShutdown</span>=<span class="string">”false”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">notifyListenersOnReplication</span>=<span class="string">”true”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Channel</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.group.GroupChannel”</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Membership</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.membership.McastService”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">bind</span>=<span class="string">”192.168.1.72”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">address</span>=<span class="string">”228.0.0.4”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">port</span>=<span class="string">”45564”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">frequency</span>=<span class="string">”500”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">dropTime</span>=<span class="string">”3000”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Receiver</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.transport.nio.NioReceiver”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">address</span>=<span class="string">”192.168.1.72”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">port</span>=<span class="string">”4001”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">selectorTimeout</span>=<span class="string">”100”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">maxThreads</span>=<span class="string">”6”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Sender</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.transport.ReplicationTransmitter”</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Transport</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.transport.nio.PooledParallelSender”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Sender</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Interceptor</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.group.interceptors.TcpFailureDetector”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Interceptor</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Interceptor</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Channel</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.ha.tcp.ReplicationValve”</span></span></span><br><span class="line"><span class="tag"> <span class="attr">filter</span>=<span class="string">”..gif;..js;..jpg;..png;..htm;..html;..css;..txt;”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">ClusterListener</span> <span class="attr">className</span>=<span class="string">”org.apache.catalina.ha.session.ClusterSessionListener”/</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Cluster</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>依次重启tomcat1,tomcat2,tomcat3,如果控制台打印出下面这样的字样说明集群配置成功</p><p><img src="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/assets/images/articles/cmd-output.jpg" alt title="控制台打印结果"><br>接下来我们来验证下集群配置是否成功</p><p>1.修改每个tomcat下<code>webapps\ROOT\WEB-INF</code>目录下的<code>web.xml</code>文件中加入<br></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distrbutable</span>/&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>配合实现session共享</p><p>2.修改每个tomcat 下<code>webapps\ROOT</code>目录中的<code>index.jsp</code></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=”text/html; charset=utf-<span class="number">8</span>” %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=”java.util.*” %&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Cluster App Test&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">System.out.println(“SessionID:” + session.getId());</span><br><span class="line">%&gt;</span><br><span class="line">Server Info:</span><br><span class="line">&lt;%</span><br><span class="line">out.println(request.getServerName() + “ : “ + request.getServerPort()+”&lt;br&gt;”);%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">out.println(“&lt;br&gt; ID “ + session.getId()+”&lt;br&gt;”);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>3.重启tomcat,访问 <a href="http://192.168.1.72" target="_blank" rel="noopener">http://192.168.1.72</a> 观察每个tomcat控制台打印的信息，如果每个tomcat打印的sessionid都一样说明集群配置成功了。</p><div class="end-of-file">END</div></div><footer class="article-footer"><ul class="article-meta"><li> <span class="label">发布:</span> <a href="/apachetomcatloadbalancingandclustering.html" class="article-date"><time datetime="2016-02-19T14:49:01.000Z" itemprop="datePublished">2016-02-19</time></a></li><li> <span class="label">分类:</span><div class="article-category"> <a class="article-category-link" href="/category/Apache/">Apache</a></div></li><li> <span class="label">标签:</span><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tag/Apache/">Apache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tag/Tomcat/">Tomcat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tag/负载均衡/">负载均衡</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tag/集群/">集群</a></li></ul></li><hr></ul></footer></div><nav id="article-nav" class="article-nav"> <a href="/build-a-blog-with-hexo-and-github-pages-in-windows.html" id="article-nav-newer" class="article-nav-link-wrap newer"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title"> Windows环境安装Hexo并基于GitHub Pages搭建博客</div></a> <a href="/mybatis-study-note.html" id="article-nav-older" class="article-nav-link-wrap older"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">MyBatis学习笔记</div></a></nav></article><aside id="article-toc" role="navigation" class="article-toc"><div id="article-toc-inner"> <strong class="sidebar-title">目录</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前期准备"><span class="toc-text">前期准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#负载均衡"><span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#集群"><span class="toc-text">集群</span></a></li></ol> <a href="#" id="article-toc-top">回到顶部</a></div></aside><section id="gitment_ccomments" class="comments"><div id="gitment_container"></div></section></div></section></div><footer id="footer" class="post-footer footer"><div id="footerContent" class="footer-content"><div class="end-of-file">Live Happy Love Hard</div></div></footer></div><script src="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/js/gitment.js"></script><script>var date="Fri Feb 19 2016 14:49:01 GMT+0000",id=""+new Date(date).getTime(),gitment=new Gitment({id:id,owner:"summerandwinter",repo:"summerandwinter.github.io",oauth:{client_id:"7b432b7b46e71966fd88",client_secret:"2c697bec7b012bca975de41c87863d84086f8d81"}});gitment.render("gitment_container")</script><script src="//cdn.jsdelivr.net/gh/summerandwinter/summerandwinter.github.io/js/summer.js"></script><!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]--></div></body>