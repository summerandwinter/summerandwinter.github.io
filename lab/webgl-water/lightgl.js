var GL=function(){var v,r={create:function(t){t=t||{};var n,e,r=document.createElement("canvas");r.width=800,r.height=600,"alpha"in t||(t.alpha=!1);try{v=r.getContext("webgl",t)}catch(t){}try{v=v||r.getContext("experimental-webgl",t)}catch(t){}if(!v)throw new Error("WebGL not supported");return function(){v.MODELVIEW=1|o,v.PROJECTION=2|o;var f=new x,s=new x;v.modelviewMatrix=new x,v.projectionMatrix=new x;var n,e,r=[],i=[];v.matrixMode=function(t){switch(t){case v.MODELVIEW:n="modelviewMatrix",e=r;break;case v.PROJECTION:n="projectionMatrix",e=i;break;default:throw new Error("invalid matrix mode "+t)}},v.loadIdentity=function(){x.identity(v[n])},v.loadMatrix=function(t){for(var e=t.m,r=v[n].m,i=0;i<16;i++)r[i]=e[i]},v.multMatrix=function(t){v.loadMatrix(x.multiply(v[n],t,s))},v.perspective=function(t,e,r,i){v.multMatrix(x.perspective(t,e,r,i,f))},v.frustum=function(t,e,r,i,n,o){v.multMatrix(x.frustum(t,e,r,i,n,o,f))},v.ortho=function(t,e,r,i,n,o){v.multMatrix(x.ortho(t,e,r,i,n,o,f))},v.scale=function(t,e,r){v.multMatrix(x.scale(t,e,r,f))},v.translate=function(t,e,r){v.multMatrix(x.translate(t,e,r,f))},v.rotate=function(t,e,r,i){v.multMatrix(x.rotate(t,e,r,i,f))},v.lookAt=function(t,e,r,i,n,o,a,s,u){v.multMatrix(x.lookAt(t,e,r,i,n,o,a,s,u,f))},v.pushMatrix=function(){e.push(Array.prototype.slice.call(v[n].m))},v.popMatrix=function(){var t=e.pop();v[n].m=a?new Float32Array(t):t},v.project=function(t,e,r,i,n,o){i=i||v.modelviewMatrix,n=n||v.projectionMatrix,o=o||v.getParameter(v.VIEWPORT);var a=n.transformPoint(i.transformPoint(new b(t,e,r)));return new b(o[0]+o[2]*(.5*a.x+.5),o[1]+o[3]*(.5*a.y+.5),.5*a.z+.5)},v.unProject=function(t,e,r,i,n,o){i=i||v.modelviewMatrix,n=n||v.projectionMatrix,o=o||v.getParameter(v.VIEWPORT);var a=new b((t-o[0])/o[2]*2-1,(e-o[1])/o[3]*2-1,2*r-1);return x.inverse(x.multiply(n,i,f),s).transformPoint(a)},v.matrixMode(v.MODELVIEW)}(),n={mesh:new p({coords:!0,colors:!0,triangles:!1}),mode:-1,coord:[0,0,0,0],color:[1,1,1,1],pointSize:1,shader:new u("      uniform float pointSize;      varying vec4 color;      varying vec4 coord;      void main() {        color = gl_Color;        coord = gl_TexCoord;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;        gl_PointSize = pointSize;      }    ","      uniform sampler2D texture;      uniform float pointSize;      uniform bool useTexture;      varying vec4 color;      varying vec4 coord;      void main() {        gl_FragColor = color;        if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);      }    ")},v.pointSize=function(t){n.shader.uniforms({pointSize:t})},v.begin=function(t){if(-1!=n.mode)throw new Error("mismatched gl.begin() and gl.end() calls");n.mode=t,n.mesh.colors=[],n.mesh.coords=[],n.mesh.vertices=[]},v.color=function(t,e,r,i){n.color=1==arguments.length?t.toArray().concat(1):[t,e,r,i||1]},v.texCoord=function(t,e){n.coord=1==arguments.length?t.toArray(2):[t,e]},v.vertex=function(t,e,r){n.mesh.colors.push(n.color),n.mesh.coords.push(n.coord),n.mesh.vertices.push(1==arguments.length?t.toArray():[t,e,r])},v.end=function(){if(-1==n.mode)throw new Error("mismatched gl.begin() and gl.end() calls");n.mesh.compile(),n.shader.uniforms({useTexture:!!v.getParameter(v.TEXTURE_BINDING_2D)}).draw(n.mesh,n.mode),n.mode=-1},function(){var e=v,n=0,o=0,r={},a=!1,i=Object.prototype.hasOwnProperty;function s(){for(var t in r)if(i.call(r,t)&&r[t])return!0;return!1}function u(e){var t={};for(var r in e)"function"==typeof e[r]?t[r]=function(t){return function(){t.apply(e,arguments)}}(e[r]):t[r]=e[r];t.original=e,t.x=t.pageX,t.y=t.pageY;for(var i=v.canvas;i;i=i.offsetParent)t.x-=i.offsetLeft,t.y-=i.offsetTop;return a?(t.deltaX=t.x-n,t.deltaY=t.y-o):(t.deltaX=0,t.deltaY=0,a=!0),n=t.x,o=t.y,t.dragging=s(),t.preventDefault=function(){t.original.preventDefault()},t.stopPropagation=function(){t.original.stopPropagation()},t}function f(t){v=e,t=u(t),v.onmousemove&&v.onmousemove(t),t.preventDefault()}function c(t){v=e,r[t.which]=!1,s()||(h(document,"mousemove",f),h(document,"mouseup",c),l(v.canvas,"mousemove",f),l(v.canvas,"mouseup",c)),t=u(t),v.onmouseup&&v.onmouseup(t),t.preventDefault()}function t(){a=!1}l(v.canvas,"mousedown",function(t){v=e,s()||(l(document,"mousemove",f),l(document,"mouseup",c),h(v.canvas,"mousemove",f),h(v.canvas,"mouseup",c));r[t.which]=!0,t=u(t),v.onmousedown&&v.onmousedown(t);t.preventDefault()}),l(v.canvas,"mousemove",f),l(v.canvas,"mouseup",c),l(v.canvas,"mouseover",t),l(v.canvas,"mouseout",t),l(document,"contextmenu",function(){r={},a=!1})}(),(e=v).makeCurrent=function(){v=e},v.animate=function(){var r=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){setTimeout(t,1e3/60)},i=(new Date).getTime(),n=v;!function t(){v=n;var e=(new Date).getTime();v.onupdate&&v.onupdate((e-i)/1e3),v.ondraw&&v.ondraw(),r(t),i=e}()},v.fullscreen=function(t){var e=(t=t||{}).paddingTop||0,r=t.paddingLeft||0,i=t.paddingRight||0,n=t.paddingBottom||0;if(!document.body)throw new Error("document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)");function o(){v.canvas.width=window.innerWidth-r-i,v.canvas.height=window.innerHeight-e-n,v.viewport(0,0,v.canvas.width,v.canvas.height),!t.camera&&"camera"in t||(v.matrixMode(v.PROJECTION),v.loadIdentity(),v.perspective(t.fov||45,v.canvas.width/v.canvas.height,t.near||.1,t.far||1e3),v.matrixMode(v.MODELVIEW)),v.ondraw&&v.ondraw()}document.body.appendChild(v.canvas),document.body.style.overflow="hidden",v.canvas.style.position="absolute",v.canvas.style.left=r+"px",v.canvas.style.top=e+"px",l(window,"resize",o),o()},v},keys:{},Matrix:x,Indexer:g,Buffer:n,Mesh:p,HitTest:w,Raytracer:t,Shader:u,Texture:M,Vector:b};function i(t){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[t]||(65<=t&&t<=90?String.fromCharCode(t):null)}function l(t,e,r){t.addEventListener(e,r)}function h(t,e,r){t.removeEventListener(e,r)}l(document,"keydown",function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var e=i(t.keyCode);e&&(r.keys[e]=!0),r.keys[t.keyCode]=!0}}),l(document,"keyup",function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var e=i(t.keyCode);e&&(r.keys[e]=!1),r.keys[t.keyCode]=!1}});var o=305397760,a="undefined"!=typeof Float32Array;function x(){var t=Array.prototype.concat.apply([],arguments);t.length||(t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.m=a?new Float32Array(t):t}function g(){this.unique=[],this.indices=[],this.map={}}function n(t,e){this.buffer=null,this.target=t,this.type=e,this.data=[]}function p(t){t=t||{},this.vertexBuffers={},this.indexBuffers={},this.addVertexBuffer("vertices","gl_Vertex"),t.coords&&this.addVertexBuffer("coords","gl_TexCoord"),t.normals&&this.addVertexBuffer("normals","gl_Normal"),t.colors&&this.addVertexBuffer("colors","gl_Color"),"triangles"in t&&!t.triangles||this.addIndexBuffer("triangles"),t.lines&&this.addIndexBuffer("lines")}x.prototype={inverse:function(){return x.inverse(this,new x)},transpose:function(){return x.transpose(this,new x)},multiply:function(t){return x.multiply(this,t,new x)},transformPoint:function(t){var e=this.m;return new b(e[0]*t.x+e[1]*t.y+e[2]*t.z+e[3],e[4]*t.x+e[5]*t.y+e[6]*t.z+e[7],e[8]*t.x+e[9]*t.y+e[10]*t.z+e[11]).divide(e[12]*t.x+e[13]*t.y+e[14]*t.z+e[15])},transformVector:function(t){var e=this.m;return new b(e[0]*t.x+e[1]*t.y+e[2]*t.z,e[4]*t.x+e[5]*t.y+e[6]*t.z,e[8]*t.x+e[9]*t.y+e[10]*t.z)}},x.inverse=function(t,e){e=e||new x;var r=t.m,i=e.m;i[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],i[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],i[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],i[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],i[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],i[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],i[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],i[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],i[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],i[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],i[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],i[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],i[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],i[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],i[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],i[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];for(var n=r[0]*i[0]+r[1]*i[4]+r[2]*i[8]+r[3]*i[12],o=0;o<16;o++)i[o]/=n;return e},x.transpose=function(t,e){e=e||new x;var r=t.m,i=e.m;return i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15],e},x.multiply=function(t,e,r){r=r||new x;var i=t.m,n=e.m,o=r.m;return o[0]=i[0]*n[0]+i[1]*n[4]+i[2]*n[8]+i[3]*n[12],o[1]=i[0]*n[1]+i[1]*n[5]+i[2]*n[9]+i[3]*n[13],o[2]=i[0]*n[2]+i[1]*n[6]+i[2]*n[10]+i[3]*n[14],o[3]=i[0]*n[3]+i[1]*n[7]+i[2]*n[11]+i[3]*n[15],o[4]=i[4]*n[0]+i[5]*n[4]+i[6]*n[8]+i[7]*n[12],o[5]=i[4]*n[1]+i[5]*n[5]+i[6]*n[9]+i[7]*n[13],o[6]=i[4]*n[2]+i[5]*n[6]+i[6]*n[10]+i[7]*n[14],o[7]=i[4]*n[3]+i[5]*n[7]+i[6]*n[11]+i[7]*n[15],o[8]=i[8]*n[0]+i[9]*n[4]+i[10]*n[8]+i[11]*n[12],o[9]=i[8]*n[1]+i[9]*n[5]+i[10]*n[9]+i[11]*n[13],o[10]=i[8]*n[2]+i[9]*n[6]+i[10]*n[10]+i[11]*n[14],o[11]=i[8]*n[3]+i[9]*n[7]+i[10]*n[11]+i[11]*n[15],o[12]=i[12]*n[0]+i[13]*n[4]+i[14]*n[8]+i[15]*n[12],o[13]=i[12]*n[1]+i[13]*n[5]+i[14]*n[9]+i[15]*n[13],o[14]=i[12]*n[2]+i[13]*n[6]+i[14]*n[10]+i[15]*n[14],o[15]=i[12]*n[3]+i[13]*n[7]+i[14]*n[11]+i[15]*n[15],r},x.identity=function(t){var e=(t=t||new x).m;return e[0]=e[5]=e[10]=e[15]=1,e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,t},x.perspective=function(t,e,r,i,n){var o=Math.tan(t*Math.PI/360)*r,a=o*e;return x.frustum(-a,a,-o,o,r,i,n)},x.frustum=function(t,e,r,i,n,o,a){var s=(a=a||new x).m;return s[0]=2*n/(e-t),s[1]=0,s[2]=(e+t)/(e-t),s[3]=0,s[4]=0,s[5]=2*n/(i-r),s[6]=(i+r)/(i-r),s[7]=0,s[8]=0,s[9]=0,s[10]=-(o+n)/(o-n),s[11]=-2*o*n/(o-n),s[12]=0,s[13]=0,s[14]=-1,s[15]=0,a},x.ortho=function(t,e,r,i,n,o,a){var s=(a=a||new x).m;return s[0]=2/(e-t),s[1]=0,s[2]=0,s[3]=-(e+t)/(e-t),s[4]=0,s[5]=2/(i-r),s[6]=0,s[7]=-(i+r)/(i-r),s[8]=0,s[9]=0,s[10]=-2/(o-n),s[11]=-(o+n)/(o-n),s[12]=0,s[13]=0,s[14]=0,s[15]=1,a},x.scale=function(t,e,r,i){var n=(i=i||new x).m;return n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,i},x.translate=function(t,e,r,i){var n=(i=i||new x).m;return n[0]=1,n[1]=0,n[2]=0,n[3]=t,n[4]=0,n[5]=1,n[6]=0,n[7]=e,n[8]=0,n[9]=0,n[10]=1,n[11]=r,n[12]=0,n[13]=0,n[14]=0,n[15]=1,i},x.rotate=function(t,e,r,i,n){if(!t||!e&&!r&&!i)return x.identity(n);var o=(n=n||new x).m,a=Math.sqrt(e*e+r*r+i*i);t*=Math.PI/180,e/=a,r/=a,i/=a;var s=Math.cos(t),u=Math.sin(t),f=1-s;return o[0]=e*e*f+s,o[1]=e*r*f-i*u,o[2]=e*i*f+r*u,o[3]=0,o[4]=r*e*f+i*u,o[5]=r*r*f+s,o[6]=r*i*f-e*u,o[7]=0,o[8]=i*e*f-r*u,o[9]=i*r*f+e*u,o[10]=i*i*f+s,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,n},x.lookAt=function(t,e,r,i,n,o,a,s,u,f){var c=(f=f||new x).m,l=new b(t,e,r),h=new b(i,n,o),m=new b(a,s,u),d=l.subtract(h).unit(),v=m.cross(d).unit(),g=d.cross(v).unit();return c[0]=v.x,c[1]=v.y,c[2]=v.z,c[3]=-v.dot(l),c[4]=g.x,c[5]=g.y,c[6]=g.z,c[7]=-g.dot(l),c[8]=d.x,c[9]=d.y,c[10]=d.z,c[11]=-d.dot(l),c[12]=0,c[13]=0,c[14]=0,c[15]=1,f},g.prototype={add:function(t){var e=JSON.stringify(t);return e in this.map||(this.map[e]=this.unique.length,this.unique.push(t)),this.map[e]}},n.prototype={compile:function(t){for(var e=[],r=0;r<this.data.length;r+=1e4)e=Array.prototype.concat.apply(e,this.data.slice(r,r+1e4));var i=this.data.length?e.length/this.data.length:0;if(i!=Math.round(i))throw new Error("buffer elements not of consistent size, average size is "+i);this.buffer=this.buffer||v.createBuffer(),this.buffer.length=e.length,this.buffer.spacing=i,v.bindBuffer(this.target,this.buffer),v.bufferData(this.target,new this.type(e),t||v.STATIC_DRAW)}},p.prototype={addVertexBuffer:function(t,e){var r=this.vertexBuffers[e]=new n(v.ARRAY_BUFFER,Float32Array);this[r.name=t]=[]},addIndexBuffer:function(t){this.indexBuffers[t]=new n(v.ELEMENT_ARRAY_BUFFER,Uint16Array);this[t]=[]},compile:function(){for(var t in this.vertexBuffers){(r=this.vertexBuffers[t]).data=this[r.name],r.compile()}for(var e in this.indexBuffers){var r;(r=this.indexBuffers[e]).data=this[e],r.compile()}},transform:function(e){if(this.vertices=this.vertices.map(function(t){return e.transformPoint(b.fromArray(t)).toArray()}),this.normals){var r=e.inverse().transpose();this.normals=this.normals.map(function(t){return r.transformVector(b.fromArray(t)).unit().toArray()})}return this.compile(),this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var t=0;t<this.vertices.length;t++)this.normals[t]=new b;for(t=0;t<this.triangles.length;t++){var e=this.triangles[t],r=b.fromArray(this.vertices[e[0]]),i=b.fromArray(this.vertices[e[1]]),n=b.fromArray(this.vertices[e[2]]),o=i.subtract(r).cross(n.subtract(r)).unit();this.normals[e[0]]=this.normals[e[0]].add(o),this.normals[e[1]]=this.normals[e[1]].add(o),this.normals[e[2]]=this.normals[e[2]].add(o)}for(t=0;t<this.vertices.length;t++)this.normals[t]=this.normals[t].unit().toArray();return this.compile(),this},computeWireframe:function(){for(var t=new g,e=0;e<this.triangles.length;e++)for(var r=this.triangles[e],i=0;i<r.length;i++){var n=r[i],o=r[(i+1)%r.length];t.add([Math.min(n,o),Math.max(n,o)])}return this.lines||this.addIndexBuffer("lines"),this.lines=t.unique,this.compile(),this},getAABB:function(){var t={min:new b(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};t.max=t.min.negative();for(var e=0;e<this.vertices.length;e++){var r=b.fromArray(this.vertices[e]);t.min=b.min(t.min,r),t.max=b.max(t.max,r)}return t},getBoundingSphere:function(){for(var t=this.getAABB(),e={center:t.min.add(t.max).divide(2),radius:0},r=0;r<this.vertices.length;r++)e.radius=Math.max(e.radius,b.fromArray(this.vertices[r]).subtract(e.center).length());return e}},p.plane=function(t){var e=new p(t=t||{});detailX=t.detailX||t.detail||1,detailY=t.detailY||t.detail||1;for(var r=0;r<=detailY;r++)for(var i=r/detailY,n=0;n<=detailX;n++){var o=n/detailX;if(e.vertices.push([2*o-1,2*i-1,0]),e.coords&&e.coords.push([o,i]),e.normals&&e.normals.push([0,0,1]),n<detailX&&r<detailY){var a=n+r*(detailX+1);e.triangles.push([a,a+1,a+detailX+1]),e.triangles.push([a+detailX+1,a+1,a+detailX+2])}}return e.compile(),e};var s=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];function y(t){return new b(2*(1&t)-1,(2&t)-1,(4&t)/2-1)}function w(t,e,r){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=e,this.normal=r}function t(){var t=v.getParameter(v.VIEWPORT),e=v.modelviewMatrix.m,r=new b(e[0],e[4],e[8]),i=new b(e[1],e[5],e[9]),n=new b(e[2],e[6],e[10]),o=new b(e[3],e[7],e[11]);this.eye=new b(-o.dot(r),-o.dot(i),-o.dot(n));var a=t[0],s=a+t[2],u=t[1],f=u+t[3];this.ray00=v.unProject(a,u,1).subtract(this.eye),this.ray10=v.unProject(s,u,1).subtract(this.eye),this.ray01=v.unProject(a,f,1).subtract(this.eye),this.ray11=v.unProject(s,f,1).subtract(this.eye),this.viewport=t}function f(t,e,r){for(;null!=(result=t.exec(e));)r(result)}p.cube=function(t){for(var e=new p(t),r=0;r<s.length;r++){for(var i=s[r],n=4*r,o=0;o<4;o++){var a=i[o];e.vertices.push(y(a).toArray()),e.coords&&e.coords.push([1&o,(2&o)/2]),e.normals&&e.normals.push(i.slice(4,7))}e.triangles.push([n,n+1,n+2]),e.triangles.push([n+2,n+1,n+3])}return e.compile(),e},p.sphere=function(t){function e(t,e,r){return s?[t,r,e]:[t,e,r]}function r(t){return t+(t-t*t)/2}var i=new p(t=t||{}),n=new g;detail=t.detail||6;for(var o=0;o<8;o++)for(var a=y(o),s=0<a.x*a.y*a.z,u=[],f=0;f<=detail;f++){for(var c=0;f+c<=detail;c++){var l=f/detail,h=c/detail,m=(detail-f-c)/detail,d={vertex:new b(r(l),r(h),r(m)).unit().multiply(a).toArray()};i.coords&&(d.coord=0<a.y?[1-l,m]:[m,1-l]),u.push(n.add(d))}if(0<f)for(c=0;f+c<=detail;c++){l=(f-1)*(detail+1)+(f-1-(f-1)*(f-1))/2+c,h=f*(detail+1)+(f-f*f)/2+c;i.triangles.push(e(u[l],u[l+1],u[h])),f+c<detail&&i.triangles.push(e(u[h],u[l+1],u[h+1]))}}return i.vertices=n.unique.map(function(t){return t.vertex}),i.coords&&(i.coords=n.unique.map(function(t){return t.coord})),i.normals&&(i.normals=i.vertices),i.compile(),i},p.load=function(t,e){"coords"in(e=e||{})||(e.coords=!!t.coords),"normals"in e||(e.normals=!!t.normals),"colors"in e||(e.colors=!!t.colors),"triangles"in e||(e.triangles=!!t.triangles),"lines"in e||(e.lines=!!t.lines);var r=new p(e);return r.vertices=t.vertices,r.coords&&(r.coords=t.coords),r.normals&&(r.normals=t.normals),r.colors&&(r.colors=t.colors),r.triangles&&(r.triangles=t.triangles),r.lines&&(r.lines=t.lines),r.compile(),r},w.prototype={mergeWith:function(t){0<t.t&&t.t<this.t&&(this.t=t.t,this.hit=t.hit,this.normal=t.normal)}},t.prototype={getRayForPixel:function(t,e){t=(t-this.viewport[0])/this.viewport[2],e=1-(e-this.viewport[1])/this.viewport[3];var r=b.lerp(this.ray00,this.ray10,t),i=b.lerp(this.ray01,this.ray11,t);return b.lerp(r,i,e).unit()}},t.hitTestBox=function(t,e,r,i){var n=r.subtract(t).divide(e),o=i.subtract(t).divide(e),a=b.min(n,o),s=b.max(n,o),u=a.max(),f=s.min();if(0<u&&u<f){var c=t.add(e.multiply(u));return r=r.add(1e-6),i=i.subtract(1e-6),new w(u,c,new b((c.x>i.x)-(c.x<r.x),(c.y>i.y)-(c.y<r.y),(c.z>i.z)-(c.z<r.z)))}return null},t.hitTestSphere=function(t,e,r,i){var n=t.subtract(r),o=e.dot(e),a=2*e.dot(n),s=a*a-4*o*(n.dot(n)-i*i);if(0<s){var u=(-a-Math.sqrt(s))/(2*o),f=t.add(e.multiply(u));return new w(u,f,f.subtract(r).divide(i))}return null},t.hitTestTriangle=function(t,e,r,i,n){var o=i.subtract(r),a=n.subtract(r),s=o.cross(a).unit(),u=s.dot(r.subtract(t))/s.dot(e);if(0<u){var f=t.add(e.multiply(u)),c=f.subtract(r),l=a.dot(a),h=a.dot(o),m=a.dot(c),d=o.dot(o),v=o.dot(c),g=l*d-h*h,x=(d*m-h*v)/g,p=(l*v-h*m)/g;if(0<=x&&0<=p&&x+p<=1)return new w(u,f,s)}return null};var E="LIGHTGL";function u(t,e){function r(t){var e=document.getElementById(t);return e?e.text:t}var i="    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",n=(t=r(t))+(e=r(e)),o={};function a(t,e){var r={},i=/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/.exec(e);return e=i?i[1]+t+e.substr(i[1].length):t+e,f(/\bgl_\w+\b/g,t,function(t){t in r||(e=e.replace(new RegExp("\\b"+t+"\\b","g"),E+t),r[t]=!0)}),e}function s(t,e){var r=v.createShader(t);if(v.shaderSource(r,e),v.compileShader(r),!v.getShaderParameter(r,v.COMPILE_STATUS))throw new Error("compile error: "+v.getShaderInfoLog(r));return r}if(f(/\b(gl_[^;]*)\b;/g,i,function(t){var e=t[1];if(-1!=n.indexOf(e)){var r=e.replace(/[a-z_]/g,"");o[r]=E+e}}),-1!=n.indexOf("ftransform")&&(o.MVPM=E+"gl_ModelViewProjectionMatrix"),this.usedMatrices=o,t=a("    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;      attribute vec4 gl_Vertex;    attribute vec4 gl_TexCoord;    attribute vec3 gl_Normal;    attribute vec4 gl_Color;    vec4 ftransform() {      return gl_ModelViewProjectionMatrix * gl_Vertex;    }  ",t),e=a("    precision highp float;      uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",e),this.program=v.createProgram(),v.attachShader(this.program,s(v.VERTEX_SHADER,t)),v.attachShader(this.program,s(v.FRAGMENT_SHADER,e)),v.linkProgram(this.program),!v.getProgramParameter(this.program,v.LINK_STATUS))throw new Error("link error: "+v.getProgramInfoLog(this.program));this.attributes={},this.uniformLocations={};var u={};f(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,t+e,function(t){u[t[2]]=1}),this.isSampler=u}var c,m,d;new x,new x;function M(t,e,r){r=r||{},this.id=v.createTexture(),this.width=t,this.height=e,this.format=r.format||v.RGBA,this.type=r.type||v.UNSIGNED_BYTE;var i=r.filter||r.magFilter||v.LINEAR,n=r.filter||r.minFilter||v.LINEAR;if(this.type===v.FLOAT){if(!M.canUseFloatingPointTextures())throw new Error("OES_texture_float is required but not supported");if((n!==v.NEAREST||i!==v.NEAREST)&&!M.canUseFloatingPointLinearFiltering())throw new Error("OES_texture_float_linear is required but not supported")}v.bindTexture(v.TEXTURE_2D,this.id),v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,1),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,i),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,n),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,r.wrap||r.wrapS||v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,r.wrap||r.wrapT||v.CLAMP_TO_EDGE),v.texImage2D(v.TEXTURE_2D,0,this.format,t,e,0,this.format,this.type,null)}function b(t,e,r){this.x=t||0,this.y=e||0,this.z=r||0}return u.prototype={uniforms:function(t){for(var e in v.useProgram(this.program),t){var r=this.uniformLocations[e]||v.getUniformLocation(this.program,e);if(r){this.uniformLocations[e]=r;var i=t[e];if(i instanceof b?i=[i.x,i.y,i.z]:i instanceof x&&(i=i.m),a=i,void 0,"[object Array]"==(s=Object.prototype.toString.call(a))||"[object Float32Array]"==s)switch(i.length){case 1:v.uniform1fv(r,new Float32Array(i));break;case 2:v.uniform2fv(r,new Float32Array(i));break;case 3:v.uniform3fv(r,new Float32Array(i));break;case 4:v.uniform4fv(r,new Float32Array(i));break;case 9:v.uniformMatrix3fv(r,!1,new Float32Array([i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]]));break;case 16:v.uniformMatrix4fv(r,!1,new Float32Array([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14],i[3],i[7],i[11],i[15]]));break;default:throw new Error("don't know how to load uniform \""+e+'" of length '+i.length)}else{if(n=i,void 0,"[object Number]"!=(o=Object.prototype.toString.call(n))&&"[object Boolean]"!=o)throw new Error('attempted to set uniform "'+e+'" to invalid value '+i);(this.isSampler[e]?v.uniform1i:v.uniform1f).call(v,r,i)}}}var n,o,a,s;return this},draw:function(t,e){this.drawBuffers(t.vertexBuffers,t.indexBuffers[e==v.LINES?"lines":"triangles"],arguments.length<2?v.TRIANGLES:e)},drawBuffers:function(t,e,r){var i=this.usedMatrices,n=v.modelviewMatrix,o=v.projectionMatrix,a=i.MVMI||i.NM?n.inverse():null,s=i.PMI?o.inverse():null,u=i.MVPM||i.MVPMI?o.multiply(n):null,f={};if(i.MVM&&(f[i.MVM]=n),i.MVMI&&(f[i.MVMI]=a),i.PM&&(f[i.PM]=o),i.PMI&&(f[i.PMI]=s),i.MVPM&&(f[i.MVPM]=u),i.MVPMI&&(f[i.MVPMI]=u.inverse()),i.NM){var c=a.m;f[i.NM]=[c[0],c[4],c[8],c[1],c[5],c[9],c[2],c[6],c[10]]}this.uniforms(f);var l=0;for(var h in t){var m=t[h],d=this.attributes[h]||v.getAttribLocation(this.program,h.replace(/^(gl_.*)$/,E+"$1"));-1!=d&&m.buffer&&(this.attributes[h]=d,v.bindBuffer(v.ARRAY_BUFFER,m.buffer),v.enableVertexAttribArray(d),v.vertexAttribPointer(d,m.buffer.spacing,v.FLOAT,!1,0,0),l=m.buffer.length/m.buffer.spacing)}for(var h in this.attributes)h in t||v.disableVertexAttribArray(this.attributes[h]);return!l||e&&!e.buffer||(e?(v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,e.buffer),v.drawElements(r,e.buffer.length,v.UNSIGNED_SHORT,0)):v.drawArrays(r,0,l)),this}},M.prototype={bind:function(t){v.activeTexture(v.TEXTURE0+(t||0)),v.bindTexture(v.TEXTURE_2D,this.id)},unbind:function(t){v.activeTexture(v.TEXTURE0+(t||0)),v.bindTexture(v.TEXTURE_2D,null)},canDrawTo:function(){c=c||v.createFramebuffer(),v.bindFramebuffer(v.FRAMEBUFFER,c),v.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,v.TEXTURE_2D,this.id,0);var t=v.checkFramebufferStatus(v.FRAMEBUFFER)==v.FRAMEBUFFER_COMPLETE;return v.bindFramebuffer(v.FRAMEBUFFER,null),t},drawTo:function(t){var e=v.getParameter(v.VIEWPORT);if(c=c||v.createFramebuffer(),m=m||v.createRenderbuffer(),v.bindFramebuffer(v.FRAMEBUFFER,c),v.bindRenderbuffer(v.RENDERBUFFER,m),this.width==m.width&&this.height==m.height||(m.width=this.width,m.height=this.height,v.renderbufferStorage(v.RENDERBUFFER,v.DEPTH_COMPONENT16,this.width,this.height)),v.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,v.TEXTURE_2D,this.id,0),v.framebufferRenderbuffer(v.FRAMEBUFFER,v.DEPTH_ATTACHMENT,v.RENDERBUFFER,m),v.checkFramebufferStatus(v.FRAMEBUFFER)!=v.FRAMEBUFFER_COMPLETE)throw new Error("Rendering to this texture is not supported (incomplete framebuffer)");v.viewport(0,0,this.width,this.height),t(),v.bindFramebuffer(v.FRAMEBUFFER,null),v.bindRenderbuffer(v.RENDERBUFFER,null),v.viewport(e[0],e[1],e[2],e[3])},swapWith:function(t){var e;e=t.id,t.id=this.id,this.id=e,e=t.width,t.width=this.width,this.width=e,e=t.height,t.height=this.height,this.height=e}},M.fromImage=function(t,e){e=e||{};var r=new M(t.width,t.height,e);try{v.texImage2D(v.TEXTURE_2D,0,r.format,r.format,r.type,t)}catch(t){throw"file:"==location.protocol?new Error('image not loaded for security reasons (serve this page over "http://" instead)'):new Error("image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)")}return e.minFilter&&e.minFilter!=v.NEAREST&&e.minFilter!=v.LINEAR&&v.generateMipmap(v.TEXTURE_2D),r},M.fromURL=function(t,e){d=d||function(){var t=document.createElement("canvas").getContext("2d");t.canvas.width=t.canvas.height=128;for(var e=0;e<t.canvas.height;e+=16)for(var r=0;r<t.canvas.width;r+=16)t.fillStyle=16&(r^e)?"#FFF":"#DDD",t.fillRect(r,e,16,16);return t.canvas}();var r=M.fromImage(d,e),i=new Image,n=v;return i.onload=function(){n.makeCurrent(),M.fromImage(i,e).swapWith(r)},i.src=t,r},M.canUseFloatingPointTextures=function(){return!!v.getExtension("OES_texture_float")},M.canUseFloatingPointLinearFiltering=function(){return!!v.getExtension("OES_texture_float_linear")},b.prototype={negative:function(){return new b(-this.x,-this.y,-this.z)},add:function(t){return t instanceof b?new b(this.x+t.x,this.y+t.y,this.z+t.z):new b(this.x+t,this.y+t,this.z+t)},subtract:function(t){return t instanceof b?new b(this.x-t.x,this.y-t.y,this.z-t.z):new b(this.x-t,this.y-t,this.z-t)},multiply:function(t){return t instanceof b?new b(this.x*t.x,this.y*t.y,this.z*t.z):new b(this.x*t,this.y*t,this.z*t)},divide:function(t){return t instanceof b?new b(this.x/t.x,this.y/t.y,this.z/t.z):new b(this.x/t,this.y/t,this.z/t)},equals:function(t){return this.x==t.x&&this.y==t.y&&this.z==t.z},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){return new b(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(t){return[this.x,this.y,this.z].slice(0,t||3)},clone:function(){return new b(this.x,this.y,this.z)},init:function(t,e,r){return this.x=t,this.y=e,this.z=r,this}},b.negative=function(t,e){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},b.add=function(t,e,r){return e instanceof b?(r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z):(r.x=t.x+e,r.y=t.y+e,r.z=t.z+e),r},b.subtract=function(t,e,r){return e instanceof b?(r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z):(r.x=t.x-e,r.y=t.y-e,r.z=t.z-e),r},b.multiply=function(t,e,r){return e instanceof b?(r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z):(r.x=t.x*e,r.y=t.y*e,r.z=t.z*e),r},b.divide=function(t,e,r){return e instanceof b?(r.x=t.x/e.x,r.y=t.y/e.y,r.z=t.z/e.z):(r.x=t.x/e,r.y=t.y/e,r.z=t.z/e),r},b.cross=function(t,e,r){return r.x=t.y*e.z-t.z*e.y,r.y=t.z*e.x-t.x*e.z,r.z=t.x*e.y-t.y*e.x,r},b.unit=function(t,e){var r=t.length();return e.x=t.x/r,e.y=t.y/r,e.z=t.z/r,e},b.fromAngles=function(t,e){return new b(Math.cos(t)*Math.cos(e),Math.sin(e),Math.sin(t)*Math.cos(e))},b.randomDirection=function(){return b.fromAngles(Math.random()*Math.PI*2,Math.asin(2*Math.random()-1))},b.min=function(t,e){return new b(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.min(t.z,e.z))},b.max=function(t,e){return new b(Math.max(t.x,e.x),Math.max(t.y,e.y),Math.max(t.z,e.z))},b.lerp=function(t,e,r){return e.subtract(t).multiply(r).add(t)},b.fromArray=function(t){return new b(t[0],t[1],t[2])},r}();