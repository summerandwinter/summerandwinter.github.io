define(function(t,e,o){var i,s=t("common"),a=0,d=980,l=1,v=!1,n=parseInt($("#OpenVote").val().split("/")[1]),c=!1;-1!=[9927,9923].indexOf(n)&&(c=!0),e.init=function(){$("body").on("active",function(){$("#vote .arrow_left").on("click",function(){a=Math.max(0,a-1),$("#vote #vote_scroll").stop().animate({"margin-left":Math.min(0,-d*a)})}),$("#vote .arrow_right").on("click",function(){a=Math.min($("#vote .vote_list").length-1,a+1),$("#vote #vote_scroll").stop().animate({"margin-left":Math.max(-($("#vote .vote_list").length-1)*d,-d*a)})}),$("#vote").on("click",".guestvote",function(){var e=$(this),o=e.parents(".vote_list"),t=o.data("voteid"),a=e.data("groupid");$.extendPost(s.httpURL+$("#OpenVote").val(),{voteId:t,groupId:a},"json",function(t){if(s.loaded(),1!=t.ResultType)return s.showInfo(t.Message),!1;s.showInfo(e.html()+"已开启",1),e.hide().removeClass("not-vote"),o.find(".not-vote").size()<=0&&o.find(".stopBtn").show()},function(){s.loaded(),s.showInfo("网络繁忙，请稍后重试")})}),$("#vote").on("click",".vote_list li",function(){s.loading("数据正在准备中，请稍后");var t=$(this).parents(".vote_list").data("voteid"),e=$(this).data("itemid"),o=$(this).find("span").html(),a=$(this).find("font").html();$.extendGet(s.httpURL+$("#GetVoteItemFans").val(),{voteId:t,voteItemId:e},"json",function(t){$("#vote #vote_scroll,#vote .arrow_left,#vote .arrow_right").hide(),$("#vote").append('<div class="show-vote-fans"><span class="title">'+o+"共获得"+a+'票</span><div class="title-btn"><a class="clickBtn middleBtn graybg">点击返回</a></div><ul class="vote-fans"></ul></div>'),0<t.length&&$(t).each(function(t,e){var o="";e.IsGuest&&(o="<span></span>");var a="<li><div>"+o+'<img src="'+e.Head+'"></div><span>'+e.NickName+"</span></li>";$("#vote .vote-fans").append(a)}),$(".show-vote-fans .graybg").click(function(){$(".show-vote-fans").remove(),$("#vote #vote_scroll,#vote .arrow_left,#vote .arrow_right").show()}),s.loaded()},function(){s.showInfo("加载失败,请重试!"),s.loaded()})})}),$("body").on("modulechange",function(t,e){"vote"==e?($("#vote").show(),f()):$("#vote").hide()})};var f=function(){s.loading("数据正在准备中，请稍后");var n="";$.extendGetJSON(s.httpURL+$("#GetVote").val(),{},function(t){s.loaded(),v=t.isshow,i=t.guest,$("#vote #vote_scroll").empty(),$.each(t.group,function(t,e){n+='<a class="clickBtn middleBtn guestvote not-vote" data-groupid="'+e.Id+'">'+e.Name+"投票</a>"}),0<t.vote.length&&($.each(t.vote,function(t,e){if(1==e.Type){var o="";if(o+='<div class="vote_list" data-voteid="'+e.Id+'"><span class="title">'+e.Name+"</span>",o+='<div class="num">共<span>0</span>人参与',o+='<a class="clickBtn middleBtn beginVote" data-isvote="0" data-groupid="0" data-voteid="'+e.Id+'">开启投票</a>',o+=n,o+='</div><div class="vote-scroll-box"><ul>',e.Items&&0<e.Items.length&&$.each(e.Items,function(t,e){o+='<li data-itemid="'+e.Id+'"><span>'+e.Name+'</span><div class="normal" style="height:0;"></div><div class="guest" style="height:0;"></div><font style="bottom:10px;">0</font></li>'}),o+="</ul></div></div>",$("#vote #vote_scroll").append(o),c){var a=$("#vote #vote_scroll").find(".vote_list:last ul");a.width(120*a.find("li").size()),a.css({left:"50%","margin-left":-a.width()/2})}$("[data-voteid="+e.Id+"]")}}),$("#vote #vote_scroll").css("width",$("#vote .vote_list").length*d),$("#vote .vote_list a.beginVote").each(function(t,e){$(e).on("click",function(){h(e)})}),$("#vote .vote_list").each(function(t,e){$(e).find("li").each(function(t,e){$(e).css("left",$(e).width()*t)})}),$.each(t.vote,function(t,e){r(e.Id)}))},function(){s.loaded(),s.showInfo("网络繁忙，请稍后重试")})},h=function(a){var n=$(a).data("voteid"),t=$(a).data("groupid");s.loading("数据正在准备中，请稍后"),"0"==$(a).data("isvote")?$.extendPost(s.httpURL+$("#OpenVote").val(),{voteId:n,groupId:t},"json",function(t){s.loaded();var e=$("[data-voteid="+n+"]");if(1!=t.ResultType)return s.showInfo(t.Message),!1;$(a).addClass("stopBtn").html("关闭投票"),$(a).data("isvote","1"),1==i&&0<e.find(".guestvote").size()&&($(a).hide(),e.find(".guestvote").css("display","inline-block").addClass("not-vote")),s.showInfo("已开启投票",1);var o=setInterval(function(){r(n)},2e3);$(a).data("getid",o)},function(){s.loaded(),s.showInfo("网络繁忙，请稍后重试")}):$.extendPost(s.httpURL+$("#CloseVote").val(),{voteId:n},"json",function(t){if(s.loaded(),1!=t.ResultType)return s.showInfo(t.Message),!1;$(a).data("isvote","0"),$(a).removeClass("stopBtn").html("开启投票"),s.showInfo("已关闭投票",1),clearInterval($(a).data("getid"))},function(){s.loaded(),s.showInfo("网络繁忙，请稍后重试")})},r=function(d){$.getJSON(s.httpURL+$("#GetVoteStatistics").val(),{voteId:d},function(t){$('#vote .vote_list[data-voteid="'+d+'"] .num span').html(t.Total),0<t.Total&&(l=t.Items[0].Total,$.each(t.Items,function(t,e){var o=$('#vote .vote_list[data-voteid="'+d+'"] [data-itemid="'+e.Id+'"]');o.animate({left:120*t});var a=e.Total,n=a/l*350,i=0,s=0;s=v?(i=e.UserTotal/a*n,e.GuestTotal/a*n):(i=n,0),o.find("div.normal").animate({height:i}),o.find("div.guest").animate({height:s,bottom:i}),o.find("font").html(a).animate({bottom:n+10})}))})}});