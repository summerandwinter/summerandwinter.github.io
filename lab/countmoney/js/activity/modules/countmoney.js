define(function(n,e,t){var u,o,a,s,m=n("common"),c=n("firework"),d=0;e.init=function(){$("body").on("active",function(){$("#countmoney .money-send").on("click",function(){l()}),$("#countmoney .money-begin").on("click",function(){r()})}),$("body").on("modulechange",function(n,e){"countmoney"==e?$("#countmoney").show():$("#countmoney").hide()})};var l=function(){$(".money-index").hide(),$(".money-join").show().find("ul").empty(),m.loading("数据正在准备中，请稍后"),$.extendGet(m.httpURL+$("#PushCountMoney").val(),{},"json",function(n){m.loaded(),1==n.ResultType?(d=n.AppendData.Id,s=parseInt(n.AppendData.Duration),u=10*n.AppendData.Duration,o=setInterval(function(){$.extendGetJSON(m.httpURL+$("#GetCountMoneyJoinFans").val(),{countId:d,count:100},function(n){$(n).each(function(n,e){$('#countmoney .money-join li[data-id="'+e.Id+'"]').size()<1&&$("#countmoney .money-join ul").append('<li data-id="'+e.Id+'"><img src="'+e.Head+'"><span>'+e.NickName+"</span></li>")})})},2e3)):m.showInfo(n.Message)},function(){m.loaded(),m.showInfo("网络繁忙，请稍后重试")})},r=function(){$(".money-join").hide(),$(".money-ing").show(),clearInterval(o);var n=2,e=$("#countmoney .shakeTimes");e.show().text(3).animate({opacity:0},"slow"),a=setInterval(function(){0<n?e.text(n).css("opacity",1).animate({opacity:0},"slow"):(clearInterval(a),e.text("GO").css("opacity",1).animate({opacity:0},1e3,function(){$.extendGet(m.httpURL+$("#OpenCountMoney").val(),{countId:d},"json",function(n){1==n.ResultType?(y(),f(s)):m.showInfo(n.Message)},function(){m.showInfo("网络繁忙，请稍后重试")}),e.hide()})),n--},1e3)},y=function(){$.extendGetJSON(m.httpURL+$("#GetCountMoneyStatistics").val(),{countId:d,_r:Math.random()},function(n){if($("#countmoney .money-ing li[data-rank!=0]").attr("data-rank",0),$.each(n.Counts,function(n,e){var t;switch($("#countmoney .money-ing ul li[data-userid="+e.FansId+"]").size()<1&&$("#countmoney .money-ing ul").append('<li data-userid="'+e.FansId+'" data-header="'+e.Head+'" data-nickname="'+e.NickName+'" style="left:1000px;"><div class="number"><span>'+e.Count+'</span></div><div class="money-bg"></div><i></i><div class="money-user"><img src="'+e.Head+'"><span>'+e.NickName+"</span></div></li>"),n){case 0:t=200;break;case 1:t=300;break;case 2:t=400;break;default:t=500*Math.random()+500}if(e.Count>parseInt($("#countmoney .money-ing ul li[data-userid="+e.FansId+"] div.number span").html())){var o=setInterval(function(){$("#countmoney .money-ing ul li[data-userid="+e.FansId+"]").prepend('<img class="downmoney" src="'+$("#config>#FileWebHost").val()+'/ScreenTheme/default/images/money.gif">')},t);setTimeout(function(){clearInterval(o)},1600)}$("#countmoney .money-ing ul li[data-userid="+e.FansId+"] div.number").animate({bottom:e.Count/u*320+121+"px"}).find("span").html(e.Count),$("#countmoney .money-ing ul li[data-userid="+e.FansId+"] .money-bg").animate({height:e.Count/u*320+"px"}),$("#countmoney .money-ing ul li[data-userid="+e.FansId+"]").attr("data-rank",n+1).animate({left:120*n+"px"})}),$("#countmoney .money-ing ul li[data-rank!=0]").show(),$("#countmoney .money-ing ul li[data-rank=0]").animate({left:"1080px"},function(){$(this).hide()}),n.IsOver&&0<n.Counts.length){m.showInfo("完了,不用数了");var e="",t="",o=10<n.Counts.length?10:n.Counts.length;for(i=0;i<o;i++){var a=$("#countmoney .money-ing ul li[data-userid="+n.Counts[i].FansId+"]");3<=i?t=t+'<li><img onerror="imgError(this);" src="'+a.data("header")+'" /><span>'+a.data("nickname")+"</span></li>":e=e+'<div class="money-user-top money-user-top'+i+'"><img onerror="imgError(this);" src="'+a.data("header")+'" /><span>'+a.data("nickname")+"</span></div>"}return c.show(),$("body").append('<div class="count-money-animate"><div class="count-money-animate-bg"></div><div class="count-money-animate-content"></div>'+e+'<ul class="money-user-last">'+t+'</ul></div><a class="countmoney-submit"></a>'),$(".countmoney-submit").on("click",function(){p()}),setTimeout(function(){$(".money-user-top2").animate({"margin-left":"160px",opacity:1})},500),setTimeout(function(){$(".money-user-top1").animate({"margin-left":"-337px",opacity:1})},1e3),setTimeout(function(){$(".money-user-top0").animate({top:"270px",opacity:1})},1500),setTimeout(function(){$(".money-user-last").animate({opacity:1})},2e3),!1}setTimeout(function(){y()},2e3)},function(){setTimeout(function(){y()},5e3)})},p=function(){c.hide(),$(".countmoney-submit").remove(),$(".count-money-animate").remove(),$("#countmoneyflash").hide(),$("#countmoney .money-ing").show().find("ul").empty(),$("#countmoney .money-index").show()},f=function(n){var e=setInterval(function(){0<n?($(".money-lefttime").html("倒计时："+n),n--):clearInterval(e)},1e3)}});