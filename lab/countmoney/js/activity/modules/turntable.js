define(function(require,exports,module){var selfModuleName="turntable",moduleCommon=require("common"),fireWork=require("firework"),moduleID=$("[data-modulename="+selfModuleName+"]").data("moduleid"),turnplate,userArray=[],internalFans=[],scrollTimer,rotationBigImg=420,prizeImgWidth=40,prizeImgPositon=-20,scrollRange=136,scrollIng=!1,isGetUserFirst=!1,PrizeId=0,lotteryUser={PrizeId:PrizeId,FansId:0,NickName:"",HeadPath:""},lotteryUserId,lotteryPrizeId,hasInternalFans=!1,SubmitFansAarray=[],canPlay=!1,allImgLength=0,firstLoad=!0;exports.init=function(){$("#turntable .pointer").attr("src",$("#config>#FileWebHost").val()+"/ScreenTheme/default/images/turnplate-pointer.png"),$("body").on("modulechange",function(t,e){e==selfModuleName?($("#turntable").show(),firstLoad&&getTurntableAward(),getTurntableInternalFans(),getTurntableFans(),canPlay=!0,document.onkeydown=function(t){13==t.keyCode&&canPlay&&(stopPlay=!0,beginRotation())}):(canPlay=!1,$("#turntable").hide())})},$("body").on("active",function(){$("#isLotteryHead").click(function(){scrollHead()}),$(".turntable_submit").click(function(){$(this).hasClass("disabled")||SubmitTurntableFans()})});var beginRotation=function(){isGetUserFirst||(lotteryUser={PrizeId:0,FansId:0,NickName:"",HeadPath:""}),canPlay=!1,submitFansState=!1;for(var t=0,e=0,a=0,r=0,n=0;n<turnplate.probability.length;n++)t+=turnplate.probability[n];for(n=0;n<turnplate.count.length;n++)e+=turnplate.count[n];if(turnplate.bRotate||0==e)return moduleCommon.showInfo("奖品已经抽完了"),void(canPlay=!0);for(var n in turnplate.bRotate=!turnplate.bRotate,turnplate.probability){if(a=Math.random()*t,turnplate.probability[n]>=a&&0<turnplate.count[n]){r=1*n+1;break}t-=turnplate.probability[n]}if(0==r)for(var n in turnplate.count)if(0<turnplate.count[n]){r=1*n+1;break}if(PrizeId=turnplate.id[r-1],hasInternalFans)for(n=0;n<turnplate.id.length;n++)if(turnplate.id[n]==lotteryPrizeId&&0<turnplate.count[n]){r=1*n+1,PrizeId=lotteryPrizeId;break}lotteryUser.PrizeId=PrizeId,turnplate.count[r-1]=turnplate.count[r-1]-1,rotateFn(r,turnplate.restaraunts[r-1])},rotateFn=function(a,t){var e=a*(360/turnplate.restaraunts.length)-360/(2*turnplate.restaraunts.length);e=e<270?270-e:360-e+270,$("#wheelcanvas").stopRotate(),$("#wheelcanvas").rotate({angle:0,animateTo:e+1800,duration:8e3,callback:function(){var t=turnplate.images[a-1],e=turnplate.restaraunts[a-1];showAnimate(e,t),isGetUserFirst=!1,turnplate.bRotate=!turnplate.bRotate}})},SubmitTurntableFans=function(){if(moduleCommon.loading("正在提交，请稍后"),0<SubmitFansAarray.length){for(var t=$("<form/>"),e=0;e<SubmitFansAarray.length;e++)t.append('<input name="['+e+'].AwardId" type="hidden" value="'+SubmitFansAarray[e].PrizeId+'" />'),t.append('<input name="['+e+'].FansId" type="hidden" value="'+SubmitFansAarray[e].FansId+'" />'),t.append('<input name="['+e+'].FansNickName" type="hidden" value="'+SubmitFansAarray[e].NickName+'" />'),t.append('<input name="['+e+'].FansHead" type="hidden" value="'+SubmitFansAarray[e].HeadPath+'" />');$.extendPost(moduleCommon.httpURL+$("#SubmitTurntableFans").val()+"?moduleId="+moduleID,t.serializeArray(),"json",function(t){moduleCommon.loaded(),1==t.ResultType?(moduleCommon.showInfo("提交成功",1),$(".turntable_submit").addClass("disabled"),SubmitFansAarray=[]):moduleCommon.showInfo(t.Message)})}},showAnimate=function(t,e){fireWork.show();var a="";""!=lotteryUser.NickName&&(a="恭喜&nbsp;&nbsp;&nbsp;"+lotteryUser.NickName+"&nbsp;&nbsp;&nbsp;获得<br/>"),a+=t,$("body").append('<div class="animage-bg"><div class="light"></div><div id="turntablePrize">'+a+'<img id="rotationBigImg" src="'+e+'" /><a class="clickBtn closeAnimate">确认</a></div></div>'),$("#isLotteryHead").html(""),$("#rotationUserHead").css("opacity",0),isGetUserFirst=!1,$("#turntableFlash").css("opacity",1).show(),SubmitFansAarray.push(lotteryUser),$(".turntable_submit").removeClass("disabled"),$("#rotationBigImg").animate({height:rotationBigImg+"px"},"fast"),$(".closeAnimate").click(function(){fireWork.hide(),$(".animage-bg").animate({opacity:0},function(){$(this).remove()}),canPlay=!0}),removeUser()},getTurntableFans=function(){$("#isLotteryHead").html(""),$("#rotationUserHead ul").html("").css("top",0).hide(),$.extendGetJSON(moduleCommon.httpURL+$("#GetTurntableFans").val(),{},function(data){0<data.length&&(userArray=eval(data),$(data).each(function(t,e){$("#rotationUserHead ul").append('<li data-headpath="'+e.HeadPath+'" data-userid="'+e.Id+'" data-nickname="'+e.NickName+'" ><img onError="imgError(this)" src="'+e.Head+'"/><span>'+e.NickName+"</span></li>")}))})},getTurntableInternalFans=function(){$.extendGetJSON(moduleCommon.httpURL+$("#GetTurntableInternalFans").val(),{},function(data){0<data.length&&(internalFans=eval(data))})},getTurntableAward=function(){moduleCommon.loading("数据加载中,请稍后"),(turnplate={restaraunts:[],colors:[],probability:[],count:[],images:[],id:[],outsideRadius:282,textRadius:255,insideRadius:0,startAngle:0,bRotate:!1,getData:function(){$.extendGetJSON(moduleCommon.httpURL+$("#GetTurntableAward").val(),{},function(t){if(0<t.length){t.length<=8&&(prizeImgWidth=80,prizeImgPositon=-40),allImgLength=t.length;var a=0;$(t).each(function(t,e){turnplate.restaraunts.push(e.PrizeName),turnplate.id.push(e.Id),turnplate.images.push(e.PrizeImg),turnplate.probability.push(e.Rate),turnplate.count.push(e.Count),t%2==0?turnplate.colors.push("#ffbf29"):turnplate.colors.push("#ffdf3e"),$("#turntable").append('<img onerror="imgError(this)" src="'+e.PrizeImg+'" id="img_'+t+'" style="display:none;"/>'),document.getElementById("img_"+t).onload=function(){++a==allImgLength&&(drawRouletteWheel(),firstLoad=!1,moduleCommon.loaded())}})}$(".pointer").show()})}}).getData()},drawRouletteWheel=function(){var t=document.getElementById("wheelcanvas");if(t.getContext){var e=Math.PI/(turnplate.restaraunts.length/2),a=t.getContext("2d");a.clearRect(0,0,700,700),a.strokeStyle="#FFBE04",a.font="12px Microsoft YaHei";for(var r=0;r<turnplate.restaraunts.length;r++){var n=turnplate.startAngle+r*e;a.fillStyle=turnplate.colors[r],a.beginPath(),a.arc(350,350,turnplate.outsideRadius,n,n+e,!1),a.arc(350,350,turnplate.insideRadius,n+e,n,!0),a.stroke(),a.fill(),a.save(),a.fillStyle="#E5302F";turnplate.restaraunts[r];a.translate(350+Math.cos(n+e/2)*turnplate.textRadius,350+Math.sin(n+e/2)*turnplate.textRadius),a.rotate(n+e/2+Math.PI/2);var i=document.getElementById("img_"+r);a.drawImage(i,prizeImgPositon,-10,prizeImgWidth,prizeImgWidth),a.restore()}}},scrollHead=function(){if(!scrollIng){if($("#rotationUserHead").css("opacity",1),$("#isLotteryHead").html("").hide(),removeUser(),isGetUserFirst=!(hasInternalFans=!(scrollIng=!0)),0<internalFans.length){var t=Math.round(Math.random()*(internalFans.length-1));lotteryUserId=internalFans[t].FansId,lotteryPrizeId=internalFans[t].AwardIds[Math.round(Math.random()*(internalFans[t].AwardIds.length-1))],internalFans.splice(t,1);for(var e=0;e<userArray.length;e++)if(userArray[e].Id==lotteryUserId){$("#isLotteryHead").html('<img data-headpath="'+userArray[e].HeadPath+'" data-userid="'+userArray[e].Id+'" data-nickname="'+userArray[e].NickName+'" onError="imgError(this)" src="'+userArray[e].Head+'"/><span>'+userArray[e].NickName+"</span>"),hasInternalFans=!0;break}}var a=$("#rotationUserHead ul");a.show(),scrollTimer=setInterval(function(){a.css({top:-scrollRange}),(scrollRange+=136)>=a.height()+136&&(a.css("top",0),scrollRange=136)},50),setTimeout(function(){var t;$("#isLotteryHead").show(),t=hasInternalFans?$("#isLotteryHead").find("img"):a.find("li").eq((scrollRange-136)/136),lotteryUser={PrizeId:PrizeId,FansId:t.data("userid"),NickName:t.data("nickname"),HeadPath:t.data("headpath")},a.find("li").length<=0&&(lotteryUser={PrizeId:0,FansId:0,NickName:"",HeadPath:""}),clearInterval(scrollTimer),scrollIng=!1},1e3)}},removeUser=function(){if(""!=lotteryUser){$("#rotationUserHead ul li[data-userid="+lotteryUser.FansId+"]").remove();for(var t=0;t<userArray.length;t++)if(userArray[t].FansId==lotteryUser.FansId){userArray.splice(t,1);break}if(0<internalFans.length)for(t=0;t<userArray.length;t++)if(internalFans[t].FansId==lotteryUser.FansId){internalFans.splice(t,1);break}}lotteryUser={PrizeId:0,FansId:0,NickName:"",HeadPath:""}}});