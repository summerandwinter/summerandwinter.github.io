define(function(i,e,a){var c,t,n,l,d="grabbonus",o=i("common"),s=i("firework"),h=($("[data-modulename="+d+"]").data("moduleid"),0),u=!1,r=[],m=0,v=!1,g=!0,p=980;e.init=function(){$("body").on("active",function(){I(),$("#weixinredbag .arrow_left").on("click",function(){h=Math.max(0,h-1),$("#weixinredbag #weixinBagList .scrollList").stop().animate({"margin-left":Math.min(0,-p*h)})}),$("#weixinredbag .arrow_right").on("click",function(){h=Math.min($("#weixinredbag #weixinBagList .scrollList div").length-1,h+1),$("#weixinredbag #weixinBagList .scrollList").stop().animate({"margin-left":Math.max(-($("#weixinredbag #weixinBagList .scrollList div").length-1)*p,-p*h)})}),$("body").on("click",".endBonusAnimate",function(){$(this).remove(),g=!1,clearInterval(c)})}),$("body").on("modulechange",function(i,e){e==d?($("#weixinredbag").show(),f(),w(),u=!0):($("#weixinredbag").hide(),u=!1,x(),b())})};var w=function(){clearInterval(n),n=setInterval(function(){var i=Math.random()*$(window).width()+200,e=Math.max(.5,1*Math.random()),a=Math.max(1,parseInt(3*Math.random()+1));$("body").prepend('<div style="left:'+i+"px;zoom:"+e+'" class="downAnimate downAnimate_'+a+'" /></div>'),$(".downAnimate").each(function(i,e){$(this).bind("webkitAnimationEnd",function(){$(this).remove()})})},600)},b=function(){clearInterval(n),$(".downAnimate").remove()},f=function(){clearInterval(t),t=setInterval(function(){var i,e=600*Math.random();i=e<160?(e=-160,"left:"+100*Math.random()+"%"):.5<Math.random()?"left:-10%":"left:110%";var a=Math.max(1,parseInt(3*Math.random()+1));$("#weixinredbag").prepend('<div style="'+i+";top:"+e+'px" class="downAnimate1 downAnimate1_'+a+'"/></div>'),$(".downAnimate1").each(function(i,e){$(this).bind("webkitAnimationEnd",function(){$(this).remove()})})},600)},x=function(){clearInterval(t),$(".downAnimate1").remove()},I=function(){$.extendGetJSON(o.httpURL+$("#GetBonusBatchs").val(),{batchType:1},function(i){0<i.length&&($("#weixinredbag #weixinBagList .scrollList").css("width",i.length*p+"px"),$(i).each(function(i,e){var t="",a="",n=0;e.Winners&&0<e.Winners.length&&$(e.Winners).each(function(i,e){var a;a=3==e.Type?e.Prize:e.Money+"元现金红包",t+='<li><img src="'+e.Head+'"><span>'+e.NickName+"</span>"+a+"</li>"}),1==e.State?a='<a href="javascript:void(0);" class="startTime" data-id="'+e.Id+'">计时开始</a>':n=1;for(var d=0,o=0;o<e.Items.length;o++)d+=e.Items[o].Count;r.push({batchId:e.Id,count:d}),$("#weixinredbag #weixinBagList .scrollList").append('<div data-isover="'+n+'" data-batchid="'+e.Id+'"><h1>'+e.ActivityName+'</h1><span class="getNumber"></span><ul>'+t+"</ul>"+a+"</div>")}),$("#weixinredbag #weixinBagList a.startTime").on("click",function(){$(this).hasClass("pushed")?(v=!1,$(this).parent().attr("data-isover",1),$("#weixinredbag #weixinBagList a.startTime").show(),$(this).remove(),B($(this).data("id"))):(v=!0,$(this).parent().attr("data-isover",0),$("#weixinredbag #weixinBagList a.startTime").hide(),$(this).show().addClass("pushed").text("结束发放"),y($(this).data("id")))}))})},L=function(e){$.extendPost(o.httpURL+$("#GetBonusCount").val(),{batchId:e},"json",function(i){$("#weixinredbag #weixinBagList div[data-batchid="+e+"] span.getNumber").data("count",i.TotalCount).html("已发 "+i.ReceiveCount+" 个红包"),setTimeout(function(){v&&L(e)},2e3)})},y=function(n){o.loading("数据正在准备中，请稍后"),L(n),$.extendPost(o.httpURL+$("#PushBonus").val(),{batchId:n,moduleId:$("#weixinredbag").data("moduleid")},"json",function(i){if(o.loaded(),g=!0,1==i.ResultType){var e,a=4,t=$("#weixinredbag #weixinRedBagTimer");t.show().text(5).animate({opacity:0},"slow"),e=setInterval(function(){0<a?(t.text(a),t.css("opacity",1),t.animate({opacity:0},"slow")):(clearInterval(e),t.text("GO"),t.css("opacity",1),t.animate({opacity:0},1e3,function(){k(n),t.hide()})),a--},1e3)}else o.showInfo(i.Message)},function(){o.loaded(),o.showInfo("网络繁忙，请稍后重试")})},B=function(i){$.extendGetJSON(o.httpURL+$("#FinishBonusBatch").val(),{batchId:i},function(i){})},k=function(t){for(var n,i=0;i<r.length;i++)if(r[i].batchId==t){n=r[i].count;break}$("#weixinredbag #weixinBagList div[data-batchid="+t+"] ul li:gt(99)").remove(),l=[],$.extendGetJSON(o.httpURL+$("#GetBonusWinners").val(),{batchId:t,count:100,recordId:m},function(i){if(i.IsOver&&($("#weixinredbag div[data-batchid="+t+"]").data("isover",1),v=!1),0<i.Winners.length){var a=i.Winners.length;$(i.Winners).each(function(i,e){g?(l.push({NickName:e.NickName,Head:e.Head,Type:e.Type,Money:e.Money,Prize:e.Prize,RecordId:e.RecordId}),i==a-1&&(n<100?N(t):M(t))):($("#weixinredbag #weixinBagList div[data-batchid="+t+"] ul").prepend('<li><img src="'+e.NickName+'"><span>'+e.NickName+"</span>"+e.Prize+"</li>"),i==a-1&&setTimeout(function(){k(e.RecordId)},5e3))})}else 0==$("#weixinredbag div[data-batchid="+t+"]").data("isover")&&setTimeout(function(){k(t)},5e3)},function(){0==$("#weixinredbag div[data-batchid="+t+"]").data("isover")&&setTimeout(function(){k(t)},1e4)})},N=function(o){var s=0;clearInterval(c),c=setInterval(function(){if(s<l.length){var i,e=l[s].Head,a=l[s].Type,t=l[s].NickName,n=l[s].Money,d=l[s].Prize;i=3==a?d:n+"元现金红包",u&&$("#weixinredbag #weixinBagList div[data-batchid="+o+"]").index()==h&&T(e,i,t),$("#weixinredbag #weixinBagList div[data-batchid="+o+"] ul").prepend('<li><img src="'+e+'"><span>'+t+"</span>"+i+"</li>"),s++}else 0==$("#weixinredbag div[data-batchid="+o+"]").data("isover")&&(m=l[s-1].RecordId,k(o),clearInterval(c))},3e3)},M=function(s){var r=0;clearInterval(c),c=setInterval(function(){var i="";if(r<l.length){for(var e=1;e<=5;e++){var a=l[r].Head,t=l[r].Type,n=l[r].NickName,d=l[r].Money,o=l[r].Prize;if(i+='<li><img src="'+a+'"><span>'+n+"</span>"+(3==t?o:d+"元现金红包")+"</li>",++r==l.length)break}$("#weixinredbag #weixinBagList div[data-batchid="+s+"] ul").prepend(i),u&&$("#weixinredbag #weixinBagList div[data-batchid="+s+"]").index()==h&&A(i)}else 0==$("#weixinredbag div[data-batchid="+s+"]").data("isover")&&(m=l[r-1].RecordId,k(s),clearInterval(c))},3500)},T=function(i,e,a,t){s.show(),$("body").append('<div class="animate-bg"><div class="light"></div><img class="luckbg" src="'+$("#config>#FileWebHost").val()+'/ScreenTheme/default/images/luckbg.png" /><img src="'+i+'" class="luckUserHead"><span class="luckUserName">'+a+'</span><div class="showLuckLevel"><span>'+e+'</span></div><a class="btn endBonusAnimate">关闭动画</a></div>'),$(".luckbg").animate({width:"800px",height:"518px","margin-top":"-330px","margin-left":"-400px",opacity:"1"},"fast"),$(".luckUserHead").animate({"margin-top":"-275px"}),$(".luckUserName").animate({"margin-top":"-35px"}),$(".showLuckLevel").animate({"margin-top":"40px"}),setTimeout(function(){$(".animate-bg").animate({opacity:"0"},"slow",function(){$(this).remove()}),s.hide()},2e3)},A=function(i){s.show(),$("body").append('<div class="animate-bg"><div class="light"></div><ul class="showWinners">'+i+'</ul><a class="btn endBonusAnimate">关闭动画</a></div>'),$(".showWinners").animate({top:"300px"}),setTimeout(function(){$(".animate-bg").animate({opacity:"0"},"slow",function(){$(this).remove()}),s.hide()},2e3)}});