define(function(e,t,s){var o,l,a=e("common"),c=[],n=0,g=0,h=[],m=0,f=$("#messagewall ul:eq(1) li"),p={class:"animate_default",fontColor:"000",fontOpacity:1,borderColor:"cecece",bgColor:"fff",bgOpacity:1},r=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var e=this.toLowerCase();if(e&&r.test(e)){if(4===e.length){for(var t="#",s=1;s<4;s+=1)t+=e.slice(s,s+1).concat(e.slice(s,s+1));e=t}var o=[];for(s=1;s<7;s+=2)o.push(parseInt("0x"+e.slice(s,s+2)));return"rgba("+o.join(",")+","+p.bgOpacity+")"}return e},t.init=function(){d(),$("body").on("active",function(e,t){f.each(function(e,t){"block"==$(this).css("display")&&(h[e]=e)}),h.sort(function(){return.5-Math.random()}),u()}),$("body").on("modulechange",function(e,t){"picmsgwall"==t?$("#messagewall").show():$("#messagewall").hide()})};var d=function(){$.extendGetJSON(a.httpURL+$("#GetConfig").val(),{moduleId:100100},function(e){e&&(o=e).KXD_MessageWall_FontColor&&(p.class=o.KXD_MessageWall_ShowWay,p.fontColor=o.KXD_MessageWall_FontColor,p.fontOpacity=o.KXD_MessageWall_FontOpacity,p.borderColor=o.KXD_MessageWall_BorderColor,p.bgColor=o.KXD_MessageWall_BackgroudColor,p.bgOpacity=o.KXD_MessageWall_BackgroudOpacity,p.bgColor="#"+p.bgColor,l=p.bgColor.colorRgb()),setTimeout(function(){d()},6e4)},function(){setTimeout(function(){d()},6e4)})};imgError=function(e){$(e).attr("src",$("#config>#FileWebHost").val()+"/FansAvatar/noheader.jpg")};var u=function(){c=[],$.extendGetJSON(a.httpURL+$("#GetChatMessages").val(),{chatId:n,count:66,isDemo:$("#IsDemo").val()},function(e){0<e.length?(n=e[e.length-1].Id,c=e,o&&"1"==o.KXD_MessageWall_IsFastDisplay?y(0):v()):setTimeout(function(){u()},5e3)},function(){setTimeout(function(){u()},1e4)})},v=function(){clearInterval(m);var r=0,i=4e3;o&&o.KXD_MessageWall_DisplayDuration&&(i=parseInt(o.KXD_MessageWall_DisplayDuration)),m=setInterval(function(){if(g==h.length&&(g=0),r<c.length){var e=c[r].Type;switch(e){case 1:content=c[r].Content;break;case 2:content='<img class="imgType" src="'+c[r].Content+'" />';break;case 5:content=$.parseJSON(c[r].Content)}var t=c[r].FansNickName,s=c[r].FansHead,o=f.eq(h[g]),a=o.width(),n=o.height();5==e?($("body").append('<img src="'+content.faceUrl+'" class="myface"/><div class="myname">'+t+"</div>"),$(".myface").animate({width:"400px",height:"400px","margin-left":"-200px",top:"120px"},"slow"),$(".myname").animate({width:"500px","margin-left":"-250px",top:"520px"},"slow",function(){var e=0,t=setInterval(function(){e%2==0?$("html").css("margin-left","10px"):$("html").css("margin-left","-10px"),20<=++e&&(clearInterval(t),$("html").removeAttr("style"))},30)}),setTimeout(function(){$(".myface").animate({opacity:0},function(){$(".myface").remove()}),$(".myname").animate({opacity:0},function(){$(".myname").remove()}),o.html('<img onerror="imgError(this);" style="width:'+a+"px;height:"+n+'px;" src="'+s+'">'),g++},i-1e3)):($("#userMessage").remove(),$("#messagewall ul").append('<div id="userMessage" class="'+p.class+'"><img class="userhead" src='+s+' onerror="imgError(this);"/><div class="username">'+t+'</div><div class="userMessage" style="border-color:#'+p.borderColor+";background:"+l+'"><div class="userMessageContent" style="color:#'+p.fontColor+";opacity:"+p.fontOpacity+'">'+content+"</div></div></div>"),24<content.length?$(".userMessage").css({"font-size":"70px"}):$(".userMessage").css({"font-size":"90px"}),setTimeout(function(){$(".username").remove(),$(".userhead").animate({left:f.eq(h[g]).position().left,top:f.eq(h[g]).position().top,width:a,height:n,"margin-left":"0px",opacity:0},function(){o.html('<img onerror="imgError(this);" style="width:'+a+"px;height:"+n+'px;" src="'+s+'">'),g++,$("#userMessage").remove()})},i-1e3)),r++}else clearInterval(m),u()},i)},y=function(e){$("#threeMessageBox").remove(),$("#messagewall ul").append('<div id="threeMessageBox" class="'+p.class+'"></div>'),g>=h.length&&(g=0),e<c.length?b(e,0):u()},b=function(e,t){if(e<c.length&&t<3){switch(c[e].Type){case 1:content=c[e].Content;break;case 2:content='<img width="250" src="'+c[e].Content+'" >';break;case 5:content=$.parseJSON(c[e].Content).faceContent}var s=c[e].FansNickName,o=c[e].FansHead;$("#threeMessageBox").append('<div class="threeUsers"><img onerror="imgError(this);" class="threeUser threeUser'+t+'" src="'+o+'" /><span class="threeUser threeUser'+t+'">'+s+'</span><div class="threeUser threeUser'+t+'" style="border-color:#'+p.borderColor+";background:"+l+'"><div class="threeUserMessage" style="color:#'+p.fontColor+";opacity:"+p.fontOpacity+'">'+content+"</div></div></div>"),b(e+1,t+1)}else setTimeout(function(){for(i=0;i<$(".threeUser").length/3;i++){var e=f.eq(h[g]),t=e.width(),s=e.height(),o=e.position().left,a=e.position().top;$("#messagewall ul div.threeUser").animate({opacity:0,left:300}),$("img.threeUser"+i).animate({left:o,top:a,width:t,height:s,"margin-left":"0px",opacity:0}),$("span.threeUser"+i).animate({left:o,top:a,width:t,height:s,"margin-left":"0px",opacity:0}),e.html('<img onerror="imgError(this);" class="showUserHead" style="width:'+t+"px;height:"+s+'px;" src="'+$("img.threeUser"+i).attr("src")+'">'),g++}},4e3),setTimeout(function(){y(e)},5e3)}});