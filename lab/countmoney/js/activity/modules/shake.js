define(function(e,a,t){var s,n,o=e("common"),h=e("firework"),r=0,k=0,c=!1;a.init=function(){$("body").on("active",function(){$("#shake #readyShake").on("click",function(){d()}),$("#shake #beginShake").on("click",function(){l()})}),$("body").on("modulechange",function(e,a){"shake"==a?$("#shake").show():$("#shake").hide()})};var d=function(){$("#shake #readyShake").off("click");new Date;c=!1,o.loading("数据正在准备中，请稍后"),$.extendPost(o.httpURL+$("#PushShake").val(),{},"json",function(e){if(o.loaded(),$("#shake .shakebg").hide(),$("#shake #readyShake").on("click",function(){d()}),1==e.ResultType){$("#shake .yyyTip").hide(),$("#shake #beginShake").show(),$("#shake #shakeReadyNumber").show(),$("#shake #readyList").show(),r=e.AppendData.Id,k=e.AppendData.MaxCount;var t=0;s=setInterval(function(){$.extendGetJSON(o.httpURL+$("#GetShakeJoinFans").val(),{shakeId:r,count:100},function(e){$(e).each(function(e,a){$('#shake #readyList li[data-id="'+a.Id+'"]').size()<1&&($("#shake #readyList").append('<li data-id="'+a.Id+'"><img src="'+a.Head+'"><span>'+a.NickName+"</span></li>"),t++,$("#shake #shakeReadyNumber").html("已有"+t+"人准备"))})})},2e3)}else o.showInfo(e.Message)},function(){o.loaded(),$("#shake #readyShake").on("click",function(){d()}),o.showInfo("网络繁忙，请稍后重试")})},l=function(){$("#shake #beginShake").off("click");var e=new Date;console.log("开始摇一摇："+e.getFullYear().toString()+"-"+(e.getMonth()+1).toString()+"-"+e.getDate().toString()+" "+e.getHours().toString()+":"+e.getMinutes().toString()+":"+e.getSeconds().toString()+","+e.getMilliseconds().toString()),$("#shake #shakeReadyNumber").hide().html("已有0人准备"),$("#shake #readyList").hide().empty(),$("#shake #beginShake").hide(),clearInterval(s);var a=4,t=$("#shake #shakeTimes");t.show().text(5).animate({opacity:0},"slow"),n=setInterval(function(){0<a?t.text(a).css("opacity",1).animate({opacity:0},"slow"):(clearInterval(n),$("#shake #beginShake").on("click",function(){l()}),t.text("GO").css("opacity",1).animate({opacity:0},1e3,function(){$.extendPost(o.httpURL+$("#OpenShake").val(),{shakeId:r},"json",function(e){if(1==e.ResultType){$("#shake #shakeList").show().css("opacity",1);var a=new Date;console.log("开始获取摇一摇："+a.getFullYear().toString()+"-"+(a.getMonth()+1).toString()+"-"+a.getDate().toString()+" "+a.getHours().toString()+":"+a.getMinutes().toString()+":"+a.getSeconds().toString()+","+a.getMilliseconds().toString()),u()}else o.showInfo(e.Message)},function(){o.showInfo("网络繁忙，请稍后重试")}),t.hide()})),a--},1e3)},u=function(){new Date;$.extendGetJSON(o.httpURL+$("#GetShakeStatistics").val(),{shakeId:r,_r:Math.random()},function(e){if(e.Shakes.length<1)e.IsOver||setTimeout(function(){u()},2e3);else{if($("#shake #shakeList li[data-rank!=0]").attr("data-rank",0),$.each(e.Shakes,function(e,a){if(1*a.Count>=.25*k&&!c){$("#shakefire").css("top",0).fadeIn(),c=!0;var t=0,s=setInterval(function(){t%2==0?$("html").css("margin-left","10px"):$("html").css("margin-left","-10px"),20<=++t&&(clearInterval(s),$("html").removeAttr("style"))},30);setTimeout(function(){$("#shakefire").fadeOut()},4e3)}$("#shake #shakeList li[data-userid="+a.FansId+"]").size()<1&&$("#shake #shakeList").append('<li data-userid="'+a.FansId+'" data-header="'+a.Head+'" data-nickname="'+a.NickName+'" style="bottom:0px;display:none;"><div class="shakebox"><img onerror="imgError(this);" src="'+a.Head+'" /><div><span>0</span></div></div><span>'+a.NickName+"</span></li>"),$("#shake #shakeList li[data-userid="+a.FansId+"]>div>div").html(a.Count).animate({width:Math.max(0,Math.ceil(a.Count*(790/k)+25))}),$("#shake #shakeList li[data-userid="+a.FansId+"] img:not(.static)").animate({left:Math.ceil(a.Count*(790/k))}),$("#shake #shakeList li[data-userid="+a.FansId+"]").attr("data-rank",e+1).animate({top:68*e+"px"})}),$("#shake #shakeList li[data-rank!=0]").show(),$("#shake #shakeList li[data-rank=0]").animate({top:"544px"},function(){$(this).hide()}),e.IsOver&&0<e.Shakes.length){o.showInfo("游戏结束，不用再摇啦");var a="",t="",s=10<e.Shakes.length?10:e.Shakes.length;for(i=0;i<s;i++){var n=$("#shake #shakeList li[data-userid="+e.Shakes[i].FansId+"]");3<=i?t=t+'<li class="shakeUser'+i+'"><img onerror="imgError(this);" src="'+n.data("header")+'" /><span>'+n.data("nickname")+"</span></li>":a=a+'<div class="shakeUser shakeUser'+i+'"><img onerror="imgError(this);" src="'+n.data("header")+'" /><span>'+n.data("nickname")+"</span></div>"}return h.show(),$("body").append('<a class="clickBtn submitShake">确认名次</a><img src="'+$("#config>#FileWebHost").val()+'/ScreenTheme/default/images/top3.png" id="top3">'+a),$(".submitShake").on("click",function(){m()}),$("body").append('<ul class="shakeUserLast">'+t+"</ul>"),$("#top3").animate({top:"280px"},"fast"),setTimeout(function(){$(".shakeUser2").animate({"margin-left":"120px",opacity:1})},500),setTimeout(function(){$(".shakeUser1").animate({"margin-left":"-280px",opacity:1})},1e3),setTimeout(function(){$(".shakeUser0").animate({top:"165px",opacity:1})},1500),setTimeout(function(){$(".shakeUserLast").animate({opacity:1})},2e3),!1}setTimeout(function(){u()},2e3)}},function(){setTimeout(function(){u()},5e3)})},m=function(){h.hide(),$(".submitShake").remove(),$(".shakeUser").remove(),$(".shakeUserLast").remove(),$("#top3").remove(),$("#shake .shakebg").show(),$("#shake #shakeList").hide().empty(),$("#shake .yyyTip").show()}});