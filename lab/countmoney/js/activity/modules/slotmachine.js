define(function(t,a,i){var e="slotmachine",n=t("common"),s=t("firework"),o=$("[data-modulename="+e+"]").data("moduleid"),d=parseInt(500*Math.random()),l=5,r=0,h=10,p=[],c=[],u=0,m="",f=125,g=!1,v=!0;a.init=function(){$("body").on("active",function(){$("#option_slotNumber a").click(function(){P($(this))}),$("body").on("click","#tigerUserBox>ul>li>a",function(){var t=$(this).parent().data("level");$(this).parent().remove(),$("#option_slotPrize a[data-prizeid="+t+"] label").html(parseInt($("#option_slotPrize a[data-prizeid="+t+"] label").html())+1),$("#tigerUserBox ul").width(80*$("#tigerUserBox ul li").size())}),$(".beginTiger").click(function(){return!g&&v?(x(),!1):g?(w(),g=!1):void 0}),$(".tiger_hidden").click(function(){$(this).hasClass("on")?($("#tigerUser").show(),$(this).removeClass("on")):($("#tigerUser").hide(),$(this).addClass("on"))}),$(".tiger_submit").click(function(){I()}),$("#tigerUser a.left").click(function(){u=Math.max(0,u-1),$("#tigerUserBox ul").stop().animate({left:Math.min(0,830*-u)})}),$("#tigerUser a.right").click(function(){u=Math.min(Math.ceil($("#tigerUserBox ul").width()/830)-1,u+1),$("#tigerUserBox ul").stop().animate({left:-830*u})})}),$("body").on("modulechange",function(t,a){a==e?($("#slotmachine").show(),b(),z()):$("#slotmachine").hide()})};var z=function(){$("#tigerUserBox ul").html("").css("left",0),$.extendGetJSON(n.httpURL+$("#GetSlotMachinePrize").val(),{},function(t){0<t.length&&($("#option_slotPrize").empty(),$(t).each(function(t,a){$("#option_slotPrize").append('<a data-prizeid="'+a.Id+'" data-prizename="'+a.Name+'" data-amount="'+a.Count+'"><div>'+a.Name+"</div> <span>剩<label>"+a.Count+"</label>名</span></a>"),0<a.Fans.length&&$(a.Fans).each(function(t,a){$("#tigerUserBox ul").prepend('<li data-hasluck="1"><img onerror="imgError(this)" src="'+a.Head+'"><span>'+a.NickName+"</span></li>"),$("#tigerUserBox ul").width(80*$("#tigerUserBox ul li").size())})})),$("#option_slotPrize a").click(function(){M($(this))})},function(){n.showInfo("加载失败,请重试!"),n.loaded()})},b=function(){n.loading("数据加载中,请稍后"),c=[],$.extendGetJSON(n.httpURL+$("#GetSlotMachineFans").val(),{},function(t){0<t.length&&(c=t,k()),n.loaded()},function(){luckUl.html(""),n.showInfo("加载失败,请重试!"),n.loaded()})},k=function(){h<=5?(l=h,$(".tigerMain").addClass("oneTiger")):($(".tigerMain").removeClass("oneTiger"),l=Math.ceil(h/2)),c.length<=5&&h>c.length&&(l=c.length,$(".tigerMain").addClass("oneTiger")),$(".tigerMain").html("");for(var t=0;t<l;t++)$(".tigerMain").append('<div class="tigerList"><div><ul></ul></div></div>');5<h&&h<10&&$(".tigerList").each(function(){$(this).index()>h-l-1&&$(this).addClass("oneUser")});var a=0;for(t=0;t<c.length;t++)a==l&&(a=0),$(".tigerList").eq(a).find("ul").append('<li data-headpath="'+c[t].HeadPath+'" data-userid="'+c[t].Id+'" data-nickname="'+c[t].NickName+'" data-headpath="'+c[t].HeadPath+'"><img onError="imgError(this)" src="'+c[t].Head+'"/></li>'),a++;$(".tigerList").each(function(){var t=$($(this).find("ul"));1<t.children().size()?(t.append(t.html()),t.css("top",250-t.height()+"px")):t.css("top","0")})},x=function(){return m="",0==r?(n.showInfo("请选择奖项!"),!1):h>c.length?(n.showInfo("抽奖人数不够!"),!1):0==h?(n.showInfo("已经没有奖品了!"),!1):h>$("#option_slotPrize a[data-prizeid="+r+"]").find("label").html()?(n.showInfo("奖品数量不够哒!"),!1):(g=!(v=!1),$(".beginTiger").html("停止抽奖").addClass("beginTiger_on"),void $(".tigerList").each(function(t){var a=$(this).find("ul"),i=a.children().size()*f;a.height(i),2<a.children().size()?setTimeout(function(){U(a,i,l/2*500)},d*t):0==a.children().size()&&a.parent().remove()}))},U=function(t,a,i){t.animate({top:-a/2+f+"px"},i,"linear",function(){t.css("top",-(a-250)+"px"),U(t,a,i)})},w=function(){$(".beginTiger").html("开始抽奖").removeClass("beginTiger_on"),p=[];var l=0;$(".tigerList").each(function(t){var o=$(this).find("ul");setTimeout(function(){o.stop();var s=Math.ceil(parseInt(o.css("top"))/f)*f;o.animate({top:s},function(){var a,i,e,n;0<$(".oneTiger").size()?o.children("li").each(function(){var t=parseInt($(this).position().top);Math.abs(t+s)<=1&&(a=$(this).data("userid"),i=$(this).html(),n=$(this).data("nickname"),e=$(this).data("headpath"),p.push(a),m+='<li data-level="'+r+'" data-headpath="'+e+'" data-nickname="'+n+'" data-isluck="'+a+'">'+i+"<span>"+n+"</span></li>",$("#option_slotPrize a[data-prizeid="+r+"]").find("label").html(parseInt($("#option_slotPrize a[data-prizeid="+r+"]").find("label").html())-1))}):o.children("li").each(function(){var t=parseInt($(this).position().top);o.parent().parent().hasClass("oneUser")?Math.abs(t+s)<=1&&(a=$(this).data("userid"),i=$(this).html(),e=$(this).data("headpath"),n=$(this).data("nickname"),p.push(a),m+='<li data-level="'+r+'" data-headpath="'+e+'" data-nickname="'+n+'" data-isluck="'+a+'">'+i+"<span>"+n+"</span></li>",$("#option_slotPrize a[data-prizeid="+r+"]").find("label").html(parseInt($("#option_slotPrize a[data-prizeid="+r+"]").find("label").html())-1)):(Math.abs(t+s)<=1||Math.abs(t+f+s)<=1)&&(a=$(this).data("userid"),i=$(this).html(),e=$(this).data("headpath"),n=$(this).data("nickname"),p.push(a),m+='<li data-level="'+r+'" data-headpath="'+e+'" data-nickname="'+n+'" data-isluck="'+a+'">'+i+"<span>"+n+"</span></li>",$("#option_slotPrize a[data-prizeid="+r+"]").find("label").html(parseInt($("#option_slotPrize a[data-prizeid="+r+"]").find("label").html())-1))}),u=0,++l==$(".tigerList").size()&&_()})},d*(t+3))})},I=function(){if(0==$("#tigerUserBox li[data-hasluck!=1]").size())return n.showInfo("还没有中奖人"),!1;n.loading("正在提交，请稍后");var i=$("<form/>");$("#tigerUserBox li[data-hasluck!=1]").each(function(t,a){i.append('<input name="['+t+'].PrizeId" type="hidden" value="'+$(a).data("level")+'" />'),i.append('<input name="['+t+'].FansId" type="hidden" value="'+$(a).data("isluck")+'" />'),i.append('<input name="['+t+'].FansNickName" type="hidden" value="'+$(a).data("nickname")+'" />'),i.append('<input name="['+t+'].FansHead" type="hidden" value="'+$(a).data("headpath")+'" />')}),$.extendPost(n.httpURL+$("#SubmitSlotMachineFans").val()+"?moduleId="+o,i.serializeArray(),"json",function(t){n.loaded(),1==t.ResultType?(n.showInfo("提交成功",1),$("#tigerUserBox li[data-hasluck!=1]").attr("data-hasluck",1)):n.showInfo(t.Message)})},M=function(t){$(t).parent().prev().find("a").html($(t).find("div").html()),$(t).parent().prev().find("a").attr({"data-prizeid":$(t).data("prizeid"),"data-amount":$(t).data("amount")}),$(t).parent().siblings(".select_option").find(".newNumber").remove(),r=$(t).data("prizeid");var i=$(t).find("label").html();$(t).parent().next(".select").find("a").attr("data-number",Math.min(10,i)).html(Math.min(10,i)),0<(h=Math.min(10,i))&&k(),$(t).parent().siblings(".select_option").find("a").each(function(t,a){$(this).data("number")>i?$(this).hide():$(this).show()})},P=function(t){$(t).parent().prev().find("a").html($(t).find("div").html()),$(t).parent().prev().find("a").attr({"data-number":$(t).data("number")}),h=$(t).data("number"),k()},_=function(){s.show();var t="";$("body").append('<div class="light"></div>'),h<=3?t="bigImg":3<h&&h<7&&(t="normalImg"),$("body").append('<div id="showPrizeUser"><ul class="'+t+'">'+m+"</ul></div>"),$("#showPrizeUser li").each(function(){$("body").append('<div data-level="'+$(this).data("level")+'" data-headpath="'+$(this).data("headpath")+'" data-nickname="'+$(this).data("nickname")+'" data-isluck="'+$(this).data("isluck")+'" style="left:'+$(this).offset().left+"px;top:"+$(this).offset().top+'px" class="tigerUser '+t+'">'+$(this).html()+"</div>"),$(this).css("opacity",0)}),$("#slotmachineFlash").css("opacity",1).show();var i=$("#tigerUserBox").offset().left,e=$("#tigerUserBox").offset().top;if(setTimeout(function(){$(".tigerUser").each(function(t){var a=$(this);setTimeout(function(){a.animate({left:i+"px",top:e+"px",width:"70px",height:"70px"},"slow",function(){$("#tigerUserBox ul").prepend('<li data-level="'+a.data("level")+'" data-headpath="'+a.data("headpath")+'" data-nickname="'+a.data("nickname")+'" data-isluck="'+a.data("isluck")+'" >'+a.html()+"<a>x</a></li>"),$("#tigerUserBox ul").width(80*$("#tigerUserBox ul li").size()).css("left",0),a.remove()})},100*t),v=!0})},2500),setTimeout(function(){s.hide(),$(".light").animate({opacity:"0"},"slow",function(){$(".light").remove()}),$("#showPrizeUser").animate({opacity:"0"},"slow",function(){$("#showPrizeUser").remove()})},3e3),0<p.length)for(var a=0;a<p.length;a++){$(".tigerMain li[data-userid="+p[a]+"]").remove();for(var n=0;n<c.length;n++)p[a]==c[n].Id&&c.splice(n,1)}k()}});