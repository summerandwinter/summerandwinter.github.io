define(function(e,a,t){var l,n,d,i,s,r,c,u=e("common"),o=e("firework"),h=190,f=!0,p="",m=1,v=!1,k=1,g=30,b=$("#luck_user ul"),w="";a.init=function(){$("body").on("active",function(){$(".showNumber a").click(function(){M($(this))}),$("#beginLuck").click(function(){x()}),$("#stopLuck").click(function(){z()}),$("#removeLottery").click(function(){U()}),$("#submitLottery").click(function(){F()}),$("#luckUl").on("click","a",function(){N($(this),$(this).parent().data("level"))}),_()}),$("body").on("modulechange",function(e,a){"lottery"==a?($("#lottery").show(),y()):$("#lottery").hide()})};var _=function(){$.extendGetJSON(u.httpURL+$("#GetLotteryAward").val(),{},function(e){0<e.length&&($(".prize").empty(),$("#luckUl").empty(),$(e).each(function(e,t){if($(".prize").append('<a data-prizeid="'+t.Id+'" data-prizeimg="'+t.PrizeImg+'" data-prizename="'+t.Name+'" data-amount="'+t.Count+'"><div>'+t.Name+"</div> <span>剩<label>"+t.Count+"</label>名</span></a>"),0<t.Fans.length){$("#luckUl").find("#level_"+t.Id).length<1&&$("#luckUl").append("<div id=level_"+t.Id+" class='level'><label>"+t.Name+":<a></a></label><ul></ul></div>"),$(t.Fans).each(function(e,a){$("#level_"+t.Id).find("ul").prepend('<li data-hasluck="1" data-level="'+t.Id+'"><span></span><img onerror="imgError(this);" src="'+a.Head+'"><font>'+a.NickName+'</font><i class="hasSubmit">已提交</i></li>')});var l=$("#level_"+t.Id+" li").length;$("#level_"+t.Id+" li").each(function(e,a){$(this).find("span").html(l-$(this).index())}),$("#level_"+t.Id+" label a").text(l),$("#luckNumber").html($("#luckUl li").length)}})),$(".prize a").click(function(){H($(this))})},function(){u.showInfo("加载失败,请重试!"),u.loaded()})},y=function(){u.loading("数据加载中,请稍后"),b.html(""),p="",$.extendGetJSON(u.httpURL+$("#GetLotteryFans").val(),{isGetAll:"False"},function(e){0<e.length&&(50<e.length&&(g=1),$("#luck .active_num span").html(e.length),$(e).each(function(e,a){if(0==$("#lottery [data-isluck="+a.Id+"]").size()){var t='<li data-headpath="'+a.HeadPath+'" data-userid="'+a.Id+'"><img src="'+a.Head+'"><br><span>'+a.NickName+"</span></li>";b.append(t)}}),I()),u.loaded()},function(){b.html(""),u.showInfo("加载失败,请重试!"),u.loaded()})},I=function(){b.css("width",190*$("#luck_user").find("li").length*2),b.append(b.html())},x=function(){return $("#showPrize").hide(),1<$("#showNumber").find("a").text()?(v=!0,m=$("#showNumber").find("a").text(),k=$("#showNumber").find("a").text()):(v=!1,m=k=1),s=$("#showLevel").find("a").attr("data-prizeid"),levelMaxNum=1*$("#showLevel").find("a").attr("data-amount"),i=1*$("#showNumber").find("a").text(),r=$("#showLevel").find("a").html(),""!=p&&(b.find("li[data-userid="+p+"]").remove(),b.width(b.width()-380),p=""),""!=w&&(b.find("li").each(function(e,a){$(this).index()+1>b.find("li").length/2&&$(this).remove()}),b.append(w),I(),w=""),$("#luck_user li").length<0?(u.showInfo("当前还没有人参加活动"),!1):(2==$("#luck_user li").length&&($("#luck_user ul li:last").remove(),b.width(190),b.css("left","170px")),0==s?(u.showInfo("请选择抽奖等级"),!1):($("#test").val(m),1*m>levelMaxNum?(u.showInfo("亲，奖品没那么多!"),!1):""!=p&&i>Math.max(1,$("#luck_user li").length/2-1)?(u.showInfo("抽奖人数不够!"),!1):i>Math.max(1,$("#luck_user li").length/2)?(u.showInfo("抽奖人数不够!"),!1):(L(),void $("#lottery .condition").addClass("disabled"))))},L=function(){if(c=0,1==v&&($("#luckIng").show(),$("#luckIng span").text(m),setTimeout(function(){z(m)},3e3)),f){if($("#stopLuck").show(),$("#beginLuck").hide(),""!=p&&(b.find("li[data-userid="+p+"]").remove(),b.width(b.width()-380)),0==$("#luck_user li").length)return u.showInfo("已经没有人了!"),$("#stopLuck").hide(),$("#beginLuck").show(),!1;1==$("#luck_user li").length&&(b.width(190),b.css("left","170px")),2==$("#luck_user li").length&&($("#luck_user li:last").remove(),b.width(190),b.css("left","170px")),2<$("#luck_user li").length&&(l=setInterval(function(){b.css({left:-h}),(h+=60)>b.width()/2+45&&(b.css("left",-20),h=190),c+=50,1==v&&15e4<c&&(clearInterval(l),z(m))},g))}else u.showInfo("抽奖进行中...")},z=function(){clearInterval(l),clearInterval(n),f=!1,$("[data-prizeid="+s+"]").find("label").html(1*$("[data-prizeid="+s+"]").find("label").html()-1),$("[data-prizeid="+s+"]").attr("data-amount",1*$("[data-prizeid="+s+"]").find("label").html()),$("#beginLuck").show(),$("#stopLuck").hide();var e=10,a=2;1<$("#luck_user li").length?n=setInterval(function(){if(b.css({left:-h}),h+=e,++a%2==0&&e--,h>=parseInt(b.width()/2)+45&&(b.css("left",-20),h=20),e<=1){clearInterval(n);var i=190*Math.ceil(h/190)+20;d=setInterval(function(){if(h+=1,b.css({left:-h}),h>=parseInt(b.width()/2)+45&&(b.css("left",-20),h=20,i-=b.width()/2),h==i){clearInterval(d),f=!0,$("#submitLottery").removeClass("gray"),$("#removeLottery").removeClass("gray");var e=$("#luck_user li:eq("+Math.ceil(h/190)+")");p=e.data("userid");var a=e.find("img").attr("src"),t=e.find("span").html(),l=e.data("headpath");$("#luckUl").find("#level_"+s).length<1&&$("#luckUl").prepend("<div id=level_"+s+" class='level'><label>"+r+":<a></a></label><ul></ul></div>"),$("#level_"+s).find("ul").prepend('<li data-hasluck="0" data-headpath="'+l+'" data-isluck="'+p+'" data-level="'+s+'"><span></span><a href="javascript:void(0)">x</a><img src="'+a+'"><font>'+t+"</font></li>"),$("#level_"+s+" li").each(function(e,a){$(this).find("span").html($("#level_"+s+" li").length-$(this).index())}),$("#level_"+s+" label a").text($("#level_"+s+" li").length),$("#luckNumber").html($("#luckUl li").length),1<m?(m--,setTimeout(function(){L()},0)):($("#luck_number").val(k),$("#luckIng").css("display","none"),$("#lottery .condition").removeClass("disabled")),C(a,r,t)}},10)}},30):setTimeout(function(){f=!0,$("#lottery .condition").removeClass("disabled"),$("#submitLottery").removeClass("gray"),$("#removeLottery").removeClass("gray"),p=$("#luck_user li").data("userid");var e=$("#luck_user li").find("img").attr("src"),a=$("#luck_user li").find("span").html(),t=$("#luck_user li").data("headpath");$("#luckUl").find("#level_"+s).length<1&&$("#luckUl").prepend("<div id=level_"+s+" class='level'><label>"+r+":<a></a></label><ul></ul></div>"),$("#level_"+s).find("ul").prepend('<li data-hasluck="0" data-headpath="'+t+'" data-isluck="'+p+'" data-level="'+s+'"><span></span><a href="javascript:void(0)">x</a><img src="'+e+'"><font>'+a+"</font></li>"),$("#level_"+s+" li").each(function(e,a){$(this).find("span").html($("#level_"+s+" li").length-$(this).index())}),$("#level_"+s+" label a").text($("#level_"+s+" li").length),$("#luckNumber").html($("#luckUl li").length),$("#luck_number").val(k),$("#luckIng").css("display","none"),C(e,r,a)},1e3)},N=function(e,a){var t=e.parent();1!=t.data("hasluck")&&(w=w+'<li data-userid="'+t.attr("data-isluck")+'"><img src="'+t.find("img").attr("src")+'"><br><span>'+t.find("font").html()+"</span></li>",$("[data-prizeid="+a+"]").find("label").html(1*$("[data-prizeid="+a+"]").find("label").html()+1),$("[data-prizeid="+a+"]").attr("data-amount",1*$("[data-prizeid="+a+"]").find("label").html()),_parents=$(e).parents(".level"),t.remove(),_parents.find("li").each(function(e,a){$(a).find("span").html(_parents.find("li").size()-$(a).index())}),0==_parents.find("li").length&&_parents.remove(),_parents.find("label a").text(_parents.find("li").length),$("#luckNumber").html($("#luckUl li").length))},U=function(){$("#removeLottery").hasClass("gray")||($("#removeLottery").addClass("gray"),$("#submitLottery").addClass("gray"),$("#luckUl li").each(function(e,a){if(1!=$(a).data("hasluck")){w=w+'<li data-userid="'+$(a).attr("data-isluck")+'"><img src="'+$(a).find("img").attr("src")+'"><br><span>'+$(a).find("font").html()+"</span></li>",$("[data-prizeid="+$(a).data("level")+"]").find("label").html(1*$("[data-prizeid="+$(a).data("level")+"]").find("label").html()+1),$("[data-prizeid="+$(a).data("level")+"]").attr("data-amount",1*$("[data-prizeid="+$(a).data("level")+"]").find("label").html());var t=$(a).parents(".level");$(a).remove(),t.find("li").each(function(e,a){$(a).find("span").html(t.find("li").size()-$(a).index())}),0==t.find("li").length&&t.remove(),t.find("label a").text(t.find("li").length),$("#luckNumber").html($("#luckUl li").length)}}))},C=function(e,a,t){o.show(),$("body").append('<div class="animate-bg"><div class="light"></div><img class="luckbg" src="'+$("#config>#FileWebHost").val()+'/ScreenTheme/default/images/luckbg.png" /><img src="'+e+'" class="luckUserHead" /><div class="showLuckUserName">'+t+'</div><div class="showLuckLevel">恭喜获得<span>'+a+"</span></div></div>"),$(".luckbg").animate({width:"800px",height:"518px","margin-top":"-330px","margin-left":"-400px",opacity:"1"},"fast"),$(".luckUserHead").animate({"margin-top":"-275px"}),$(".showLuckLevel").animate({"margin-top":"40px"}),$(".showLuckUserName").animate({opacity:"1"}),setTimeout(function(){o.hide(),$(".animate-bg").animate({opacity:"0"},"slow",function(){$(".animate-bg").remove()}),$("#bgsound").remove()},3e3)},F=function(e){var a=$("#luckUl li[data-hasluck!=1]").size();if(!$("#removeLottery").hasClass("gray")&&0<a){u.loading("正在提交，请稍后");var t=$("<form/>");$("#luckUl li[data-hasluck!=1]").each(function(e,a){t.append('<input name="['+e+'].AwardId" type="hidden" value="'+$(a).data("level")+'" />'),t.append('<input name="['+e+'].FansId" type="hidden" value="'+$(a).data("isluck")+'" />'),t.append('<input name="['+e+'].FansNickName" type="hidden" value="'+$(a).find("font").text()+'" />'),t.append('<input name="['+e+'].FansHead" type="hidden" value="'+$(a).data("headpath")+'" />')}),$.extendPost(u.httpURL+$("#SubmitLotteryFans").val(),t.serializeArray(),"json",function(e){u.loaded(),1==e.ResultType?(u.showInfo("提交成功",1),$("#removeLottery").addClass("gray"),$("#submitLottery").addClass("gray"),$("#luckUl li[data-hasluck!=1]").attr("data-hasluck",1).append('<i class="hasSubmit">已提交</i>').find("a").remove()):u.showInfo(e.Message)})}},H=function(e){$("#showPrize").hide(),$(e).parent().prev().find("a").html($(e).find("div").html()),$(e).parent().prev().find("a").attr({"data-prizeid":$(e).data("prizeid"),"data-amount":$(e).data("amount")}),$(e).parent().siblings(".select_option").find(".newNumber").remove();var t=$(e).find("label").html();$(e).parent().next(".select").find("a").attr("data-number",t).html(t),5<t&&($(e).parent().siblings(".select_option").append('<a class="newNumber"><div>'+t+"</div></a>"),$(".newNumber").click(function(){$(e).parent().prev(".select").find("a").html($(e).html())})),$(e).parent().siblings(".select_option").find("a").each(function(e,a){$(this).data("number")>t?$(this).hide():$(this).show()}),"block"==$("#showPrize").css("display")&&showPrize()},M=function(e){$(e).parent().prev().find("a").html($(e).find("div").html()),$(e).parent().prev().find("a").attr({"data-number":$(e).data("number")})}});