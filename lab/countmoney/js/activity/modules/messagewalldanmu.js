define(function(e,n,a){var t=e("common"),o=$("[data-modulename=messagewalldanmu]").data("moduleid"),l=0,i=0,r=[],c={font:"宋体",bold:!1,size:30,colors:["#fff"],opacity:1,speed:8};n.init=function(){$("body").on("active",function(e,n){$('#btn_change>li[data-name="messagewalldanmu"]').on("click",function(){var e=$(this);e.data("ishide")?(e.data("ishide",!1),$('#btn_change>li[data-name="messagewalldanmu"] i').html("&#xe62f;"),$("body>span.danmaku").css("display","block")):(e.data("ishide",!0),$('#btn_change>li[data-name="messagewalldanmu"] i').html("&#xe630;"),$("body>span.danmaku").css("display","none"))}),$.extendGetJSON(t.httpURL+$("#url>#GetConfig").val(),{moduleId:o},function(e){e.KXD_BulletScreen_Font&&(c.font=e.KXD_BulletScreen_Font),e.KXD_BulletScreen_Bold&&"1"==e.KXD_BulletScreen_Bold&&(c.bold=!0),e.KXD_BulletScreen_Size&&(c.size=parseInt(e.KXD_BulletScreen_Size)),e.KXD_BulletScreen_Color&&(c.colors=e.KXD_BulletScreen_Color.split(",")),e.KXD_BulletScreen_Transparency&&(c.opacity=parseFloat(e.KXD_BulletScreen_Transparency)),e.KXD_BulletScreen_Speed&&(c.speed=parseFloat(e.KXD_BulletScreen_Speed)/1e3),$("#danmu").data("rowcount",Math.floor(window.screen.height/(c.size+50))),$("#danmu").data("rowindex",0),$("#danmu").data("width",window.screen.width),d()},function(){t.showInfo("获取弹幕配置失败",0)})})},imgError=function(e){$(e).attr("src",$("#config>#FileWebHost").val()+"/FansAvatar/noheader.jpg")};var d=function(){$.extendGetJSON(t.httpURL+$("#GetBarragerMessages").val(),{barragerId:l,count:100},function(e){if(0<e.length){i=0,l=e[e.length-1].Id;var t=[];$.each(e,function(e,n){if(1==n.Type){var a={};a.info=n.FansNickName+"："+n.Content,a.font=c.font,a.bold=c.bold,a.size=c.size,a.color=c.colors[Math.floor(Math.random()*c.colors.length)],a.opacity=c.opacity,a.speed=Math.ceil(3*Math.random())/2+c.speed,t.push(a)}}),100<(r=r.concat(t)).length&&(r=r.slice(r.length-100)),s(t)}else 24==++i?(i=0,s(r)):setTimeout(function(){d()},5e3)},function(){setTimeout(function(){d()},1e4)})},s=function(e){var n=0,a=setInterval(function(){if(n==e.length)return clearInterval(a),void d();$("#danmu").barrager(e[n++])},1e3)}});