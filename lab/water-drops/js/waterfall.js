function drop(t,e,i,s,n,r,f,h){this.x=t,this.y=e,this.shading=s,this.refraction=n,this.bufferSize=this.x*this.y,this.damping=i,this.background=r.getImageData(0,0,f,h).data,this.imageData=r.getImageData(0,0,f,h),this.buffer1=[],this.buffer2=[];for(var a=0;a<this.bufferSize;a++)this.buffer1.push(0),this.buffer2.push(0);this.update=function(){for(var t=this.x+1,e=1;t<this.bufferSize-this.x;t++,e++)e<this.x?(this.buffer2[t]=(this.buffer1[t-1]+this.buffer1[t+1]+this.buffer1[t-this.x]+this.buffer1[t+this.x])/2-this.buffer2[t],this.buffer2[t]*=this.damping):e=0;var i=this.buffer1;this.buffer1=this.buffer2,this.buffer2=i},this.draw=function(t){for(var e=this.imageData.data,i=this.x+1,s=4*(this.x+1);i<this.bufferSize-(1+this.x);i++,s+=4){var n=~~(this.buffer1[i-1]-this.buffer1[i+1]),r=~~(this.buffer1[i-this.x]-this.buffer1[i+this.x]),f=n*this.shading,h=s+4*(n*this.refraction+r*this.refraction*this.x);e[s]=this.background[h]+f,e[s+1]=this.background[h+1]+f,e[s+2]=50+this.background[h+2]+f}t.putImageData(this.imageData,0,0)}}var fps=0,watereff={timeStep:20,refractions:2,shading:3,damping:.99,screenWidth:500,screenHeight:400,pond:null,textureImg:null,interval:null,backgroundURL:"data_images/underwater1.jpg",init:function(){var i=document.getElementById("water");i.getContext&&(fps=0,setInterval(function(){document.getElementById("fps").innerHTML=fps/2+" FPS",fps=0},2e3),i.onmousedown=function(t){var e=watereff.getMousePosition(t).sub(new vector2d(i.offsetLeft,i.offsetTop));watereff.pond.buffer1[e.y*watereff.pond.x+e.x]+=200},i.onmouseup=function(t){i.onmousemove=null},i.width=this.screenWidth,i.height=this.screenHeight,this.textureImg=new Image(256,256),this.textureImg.src=this.backgroundURL,i.getContext("2d").drawImage(this.textureImg,0,0),this.pond=new drop(this.screenWidth,this.screenHeight,this.damping,this.shading,this.refractions,i.getContext("2d"),this.screenWidth,this.screenHeight),null!=this.interval&&clearInterval(this.interval),this.interval=setInterval(watereff.run,this.timeStep))},changePicture:function(t){this.backgroundURL=t,this.init()},getMousePosition:function(t){if(!t)t=window.event;return t.pageX||t.pageY?new vector2d(t.pageX,t.pageY):t.clientX||t.clientY?new vector2d(t.clientX,t.clientY):void 0},run:function(){var t=document.getElementById("water").getContext("2d");watereff.pond.update(),watereff.pond.draw(t),fps++}};window.onload=function(){watereff.init()};